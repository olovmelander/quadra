<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadra - Meditative Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Space Mono', monospace;
            background-color: #0c0a1a;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* --- Background Container --- */
        .background-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow: hidden;
            z-index: -1;
        }
        
        .theme-container {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 3s ease-in-out;
            visibility: hidden;
        }
        
        .theme-container.active {
            opacity: 1;
            visibility: visible;
        }

        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 5s infinite ease-in-out;
        }

        @keyframes twinkle {
            0%, 100% { opacity: 0.5; transform: scale(0.8); }
            50% { opacity: 1; transform: scale(1); }
        }
        
        /* --- Forest Theme --- */
        #forest-theme {
            background: linear-gradient(to top, #0a0e1a, #1a223a, #2a3a5a);
            overflow: hidden;
        }
        .enchanted-forest-layer {
            position: absolute;
            bottom: 0; left: 0;
            width: 200%; height: 100%;
            background-repeat: repeat-x;
            background-position: 0 bottom;
        }
        #enchanted-forest-back { animation: slide 280s linear infinite; z-index: 1; filter: brightness(0.6); }
        #enchanted-forest-mid { animation: slide 200s linear infinite; z-index: 4; filter: brightness(0.8); }
        #enchanted-forest-front { animation: slide 120s linear infinite; z-index: 7; }

        .forest-moon {
            position: absolute;
            top: 10%; left: 0;
            width: 80px; height: 80px;
            background: radial-gradient(circle, #f0f0f0, #d0d0e0);
            border-radius: 50%;
            box-shadow: 0 0 40px #d0d0e0, 0 0 80px #f0f0f0;
            animation: moon-path 180s linear infinite;
            z-index: 2;
        }
        @keyframes moon-path {
            from { transform: translate(-10vw, 0); }
            to { transform: translate(110vw, 20vh); }
        }

        .forest-mist {
            position: absolute;
            bottom: 0; left: 0;
            width: 200%; height: 30%;
            background: linear-gradient(to top, rgba(180, 190, 200, 0.15) 0%, rgba(180, 190, 200, 0) 100%);
            animation: mist-anim 100s linear infinite alternate;
            z-index: 3;
        }

        .firefly {
            position: absolute;
            width: 5px; height: 5px;
            background-color: #f0f0aa;
            border-radius: 50%;
            box-shadow: 0 0 12px #f0f0aa, 0 0 20px #f0f0aa;
            animation: fly-enchanted 15s ease-in-out infinite;
            z-index: 6;
        }
        @keyframes fly-enchanted {
            0%, 100% {
                transform: translate(var(--x-start), var(--y-start)) scale(0.8);
                opacity: 0.5;
            }
            50% {
                transform: translate(var(--x-end), var(--y-end)) scale(1.2);
                opacity: 1;
            }
        }

        /* --- Ocean Theme --- */
        #ocean-theme {
            background: linear-gradient(to top, #000408, #021B39, #083361);
            overflow: hidden;
        }
        .ocean-parallax {
            position: absolute;
            bottom: 0; left: 0;
            width: 200%; height: 100%;
            background-repeat: repeat-x;
            background-position: 0 bottom;
        }
        #ocean-floor-bg { animation: slide 220s linear infinite; z-index: 1; opacity: 0.8; }
        #ocean-floor-mid { animation: slide 160s linear infinite; z-index: 3; opacity: 0.9; }
        #ocean-floor-fg { animation: slide 100s linear infinite; z-index: 5; }

        .caustics-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            transform-origin: center;
            animation: slow-pan 120s linear infinite alternate;
            z-index: 2;
        }
        @keyframes slow-pan {
            from { transform: translateX(-10%) scale(1.2); }
            to { transform: translateX(10%) scale(1.2); }
        }
        .caustic-light {
            position: absolute;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200"><filter id="w"><feTurbulence type="fractalNoise" baseFrequency="0.02" numOctaves="3" seed="5"/><feDiffuseLighting in="w" lighting-color="white" surfaceScale="10"><feDistantLight azimuth="45" elevation="60"/></feDiffuseLighting></filter><rect width="200" height="200" fill="rgba(200,225,255,0.1)" filter="url(%23w)"/></svg>');
            background-size: 400% 400%;
            width: 100%; height: 100%;
            animation: caustics-anim 30s ease-in-out infinite alternate;
        }
        @keyframes caustics-anim {
            from { background-position: 0% 0%; }
            to { background-position: 100% 100%; }
        }

        .sea-creature-container {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 0;
        }
        .sea-creature {
            position: absolute;
            width: 400px; height: 200px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 200"><path d="M 0 100 C 50 20, 150 0, 200 50 C 250 100, 350 80, 400 120 L 400 180 C 350 220, 250 200, 200 150 C 150 100, 50 180, 0 100 Z" fill="rgba(2, 10, 20, 0.5)"/></svg>');
            animation: creature-swim 150s linear infinite;
            opacity: 0;
        }
        @keyframes creature-swim {
            0% { transform: translateX(-450px) translateY(40vh) scale(1); opacity: 0; }
            5% { opacity: 1; }
            95% { opacity: 1; }
            100% { transform: translateX(110vw) translateY(30vh) scale(1.2); opacity: 0; }
        }

        .bubble {
            position: absolute;
            background: rgba(173, 216, 230, 0.3);
            border-radius: 50%;
            animation: rise-deep ease-in-out infinite;
        }
        @keyframes rise-deep {
            0% {
                bottom: -20px;
                transform: translateX(0) scale(1);
                opacity: 1;
            }
            50% {
                transform: translateX(var(--x-drift)) scale(1.1);
            }
            99% {
                opacity: 1;
            }
            100% {
                bottom: 105vh;
                transform: translateX(var(--x-drift-end)) scale(0.8);
                opacity: 0;
            }
        }
        
        /* --- Sunset Theme --- */
        #sunset-theme {
            overflow: hidden;
        }
        .sun-and-sky {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(to top, #f3904f, #f7b267, #e67e22, #d35400, #a04000);
            animation: sky-color-change 120s ease-in-out infinite;
            z-index: 1;
        }
        @keyframes sky-color-change {
            0% { background: linear-gradient(to top, #89c2d9, #a7c957, #f7b267, #f3904f, #e67e22); }
            50% { background: linear-gradient(to top, #f3904f, #e67e22, #d35400, #a04000, #3b3270); }
            100% { background: linear-gradient(to top, #3b3270, #1a1225, #0c0a1a, #000); }
        }
        .sun {
            position: absolute;
            top: 50%; left: 50%;
            width: 150px; height: 150px;
            background: radial-gradient(circle, #fff, #ffd700, #ff8c00);
            border-radius: 50%;
            box-shadow: 0 0 80px #ff8c00, 0 0 160px #ffd700;
            animation: sunset-path 120s linear infinite;
        }
        @keyframes sunset-path {
            0% { transform: translate(-50%, -10vh) scale(1.2); }
            100% { transform: translate(-50%, 80vh) scale(0.8); }
        }
        .lens-flare {
            position: absolute;
            top: 50%; left: 50%;
            width: 300px; height: 300px;
            background: radial-gradient(circle, rgba(255,255,220,0.3) 0%, rgba(255,255,220,0) 60%);
            border-radius: 50%;
            animation: sunset-path 120s linear infinite; /* Same as sun */
            opacity: 0.5;
        }
        .sunset-clouds {
            position: absolute;
            top: 0; left: 0;
            width: 200%; height: 100%;
            background-repeat: repeat-x;
        }
        #sunset-clouds-back { animation: slide 200s linear infinite; z-index: 2; opacity: 0.5; }
        #sunset-clouds-mid { animation: slide 150s linear infinite; z-index: 4; opacity: 0.7; }
        #sunset-clouds-front { animation: slide 100s linear infinite; z-index: 6; opacity: 1; }

        .dust-mote {
            position: absolute;
            background: rgba(255, 220, 180, 0.7);
            border-radius: 50%;
            animation: mote-drift 15s ease-in-out infinite alternate;
            z-index: 3;
        }
        @keyframes mote-drift {
            from {
                transform: translate(var(--x-start), var(--y-start));
                opacity: 0;
            }
            50% {
                opacity: 0.8;
            }
            to {
                transform: translate(var(--x-end), var(--y-end));
                opacity: 0;
            }
        }

        /* --- Zen Theme --- */
        #zen-theme {
            background-color: #d8c8b8;
            overflow: hidden;
        }
        .raked-sand {
            position: absolute;
            width: 100%; height: 100%;
            background-image:
                repeating-linear-gradient(45deg, transparent, transparent 35px, rgba(0,0,0,0.02) 35px, rgba(0,0,0,0.02) 70px),
                repeating-linear-gradient(-45deg, transparent, transparent 35px, rgba(0,0,0,0.02) 35px, rgba(0,0,0,0.02) 70px);
            filter: blur(1px);
        }
        .water-feature {
            position: absolute;
            bottom: 2%; right: 2%;
            width: 25%; height: 20%;
            background-color: #3a4a5a;
            border-radius: 45% 55% 40% 60% / 60% 50% 50% 40%;
            overflow: hidden;
            box-shadow: inset 0 0 15px rgba(0,0,0,0.5);
        }
        .zen-ripple {
            position: absolute;
            top: 50%; left: 50%;
            border: 1px solid rgba(200, 220, 240, 0.5);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            animation: zen-ripple-effect 6s ease-out infinite;
        }
        @keyframes zen-ripple-effect {
            from { width: 0; height: 0; opacity: 1; }
            to { width: 200px; height: 200px; opacity: 0; }
        }

        .petal {
            position: absolute;
            width: 18px; height: 18px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 0 C5 5, 5 15, 10 20 C15 15, 15 5, 10 0 Z" fill="rgba(255, 105, 180, 0.8)"/></svg>');
            background-size: contain;
            animation: fall-petal-zen 12s ease-in-out infinite;
            z-index: 10;
        }
        @keyframes fall-petal-zen {
            0% {
                transform: translateY(-10vh) translateX(0) rotate(var(--r-start));
                opacity: 1;
            }
            100% {
                transform: translateY(110vh) translateX(var(--x-drift)) rotate(var(--r-end));
                opacity: 0;
            }
        }

        /* --- Winter Theme --- */
        #winter-theme {
            background: linear-gradient(to top, #e0e8f0, #a0b0c0, #607080);
            overflow: hidden;
        }
        .snowflakes-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #snowflakes-back { filter: blur(2px) brightness(0.8); z-index: 1; }
        #snowflakes-mid { z-index: 3; }
        #snowflakes-front { filter: blur(0) brightness(1.2); z-index: 5; }

        .snowflake {
            position: absolute;
            color: white;
            font-family: 'Arial', sans-serif;
            animation: fall-snow linear infinite;
        }
        @keyframes fall-snow {
             from { transform: translateY(-10vh) translateX(var(--x-start)) rotate(0deg); }
             to { transform: translateY(110vh) translateX(var(--x-end)) rotate(var(--r-end)); }
        }

        .window-pane {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            pointer-events: none;
            z-index: 10;
        }
        .frost-overlay {
            width: 100%; height: 100%;
            background: radial-gradient(circle, transparent 60%, rgba(255,255,255,0.1));
            box-shadow: inset 0 0 80px rgba(230,240,255,0.3);
        }
        .ice-crystal {
            position: absolute;
            width: 0; height: 0;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 0 15px white, 0 0 25px white;
            animation: form-crystal 40s ease-out infinite;
        }
        @keyframes form-crystal {
            from {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                opacity: 0.2;
            }
            to {
                transform: scale(1);
                opacity: 0;
            }
        }
        
        /* --- Fall Theme --- */
        #fall-theme {
            background: linear-gradient(to top, #a26e49, #c88c53, #f7b267);
            overflow: hidden;
        }
        .fall-bg {
            position: absolute; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><filter id="f"><feGaussianBlur stdDeviation="3"/></filter><rect width="100" height="100" fill="%238d5524"/><g filter="url(%23f)"><circle cx="20" cy="80" r="30" fill="%23c86b53"/><circle cx="80" cy="70" r="40" fill="%23a26e49"/><circle cx="50" cy="30" r="25" fill="%23f7b267"/></g></svg>');
            background-size: cover;
            filter: blur(5px);
            transform: scale(1.1);
            z-index: 1;
        }
        .fall-leaves-layer {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
        }
        #fall-leaves-back { z-index: 2; transform: scale(0.7); filter: blur(1px) brightness(0.9); }
        #fall-leaves-mid { z-index: 4; }
        #fall-leaves-front { z-index: 6; transform: scale(1.3); filter: blur(0) brightness(1.1); }

        .leaf {
            position: absolute;
            background-size: contain;
            background-repeat: no-repeat;
            animation: fall-leaf-gust linear infinite;
        }
        @keyframes fall-leaf-gust {
            0% { transform: translate(var(--x-start), -10vh) rotate(var(--r-start)); opacity: 1; }
            20% { transform: translate(calc(var(--x-start) + var(--x-gust1)), 20vh) rotate(calc(var(--r-start) + 200deg)); }
            40% { transform: translate(calc(var(--x-start) + var(--x-gust2)), 40vh) rotate(calc(var(--r-start) + 400deg)); }
            60% { transform: translate(calc(var(--x-start) + var(--x-gust3)), 60vh) rotate(calc(var(--r-start) + 600deg)); }
            80% { transform: translate(calc(var(--x-start) + var(--x-gust4)), 80vh) rotate(calc(var(--r-start) + 800deg)); }
            100% { transform: translate(var(--x-end), 110vh) rotate(var(--r-end)); opacity: 0; }
        }
        .ground-leaves {
            position: absolute;
            bottom: 0; left: 0;
            width: 100%; height: 5%;
            background-size: 200px 100%;
            z-index: 5;
            animation: rustle 10s ease-in-out infinite alternate;
        }
        @keyframes rustle {
            from { transform: translateX(-2%); }
            to { transform: translateX(2%); }
        }
        
        /* --- Summer Theme --- */
        #summer-theme {
            background-color: #ffefd5;
            overflow: hidden;
        }
        .summer-sky {
            position: absolute; width: 100%; height: 100%;
            background: linear-gradient(to top, #fceabb, #f8b500, #ffdd77);
            z-index: 1;
        }
        .god-rays-summer {
            position: absolute; top: -20%; left: -20%;
            width: 140%; height: 140%;
            transform-origin: center;
            animation: summer-god-ray-anim 80s ease-in-out infinite alternate;
            z-index: 2;
        }
        .summer-god-ray {
            position: absolute;
            top: 0;
            background: linear-gradient(to bottom, rgba(255, 250, 220, 0.25) 0%, rgba(255, 250, 220, 0) 60%);
            transform-origin: top center;
        }
        @keyframes summer-god-ray-anim {
            from { transform: rotate(-15deg); }
            to { transform: rotate(15deg); }
        }
        .dandelion-seed {
            position: absolute;
            width: 20px;
            height: 20px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><circle cx="10" cy="10" r="1" fill="rgba(255,255,255,0.8)"/><line x1="10" y1="10" x2="5" y2="5" stroke="rgba(255,255,255,0.8)" stroke-width="0.5"/><line x1="10" y1="10" x2="15" y2="5" stroke="rgba(255,255,255,0.8)" stroke-width="0.5"/><line x1="10" y1="10" x2="5" y2="15" stroke="rgba(255,255,255,0.8)" stroke-width="0.5"/><line x1="10" y1="10" x2="15" y2="15" stroke="rgba(255,255,255,0.8)" stroke-width="0.5"/></svg>');
            background-size: contain;
            animation: float-seed 20s ease-in-out infinite;
            z-index: 4;
        }
        @keyframes float-seed {
            0% { transform: translate(var(--x-start), var(--y-start)) rotate(0deg); opacity: 0; }
            25% { opacity: 1; }
            75% { opacity: 1; }
            100% { transform: translate(var(--x-end), var(--y-end)) rotate(360deg); opacity: 0; }
        }
        .heat-haze {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><filter id="haze"><feTurbulence type="turbulence" baseFrequency="0.01 0.03" numOctaves="1" result="turbulence"/><feDisplacementMap in2="turbulence" in="SourceGraphic" scale="5" xChannelSelector="R" yChannelSelector="G"/></filter><rect width="200" height="200" fill="transparent" filter="url(%23haze)"/></svg>');
            background-size: 200px 200px;
            animation: heat-haze-anim 10s linear infinite alternate;
            opacity: 0.3;
            z-index: 5;
        }
        @keyframes heat-haze-anim {
            from { background-position: 0% 0%; }
            to { background-position: 100% 100%; }
        }
        
        /* --- Spring Theme --- */
        #spring-theme {
            background: linear-gradient(to top, #b0c4de, #dcedc1, #e0f0e8);
            overflow: hidden;
        }
        .spring-rain {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2;
        }
        .spring-raindrop {
            position: absolute; bottom: 100%; width: 1px; height: 50px;
            background: linear-gradient(to bottom, rgba(255,255,255,0), rgba(200,220,240,0.6));
            animation: spring-rain-fall linear infinite;
        }
        @keyframes spring-rain-fall {
            to { transform: translateY(calc(100vh + 50px)); }
        }
        .spring-ground {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 10%;
            background: linear-gradient(to top, #6a994e, #89c2d9);
            z-index: 1;
        }
        #sprouts-container {
            position: absolute; bottom: 8%; left: 0; width: 100%; height: 20%; z-index: 3;
        }
        .sprout {
            position: absolute; bottom: 0; width: 20px; height: 40px;
            transform-origin: bottom center;
            animation: unfurl 15s ease-in-out infinite;
        }
        .sprout > div { /* Leaf container */
            position: absolute; bottom: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 40"><path d="M 10 40 C 0 30, 0 10, 10 0 C 20 10, 20 30, 10 40 Z" fill="rgba(119, 221, 119, 0.9)"/></svg>');
            background-size: contain; background-repeat: no-repeat;
            transform-origin: bottom center;
        }
        .sprout .left { transform: rotate(-15deg); }
        .sprout .right { transform: rotate(15deg); }

        @keyframes unfurl {
            0% { transform: scaleY(0); }
            20% { transform: scaleY(1); }
            80% { transform: scaleY(1); }
            100% { transform: scaleY(0); }
        }
        .sprout::after { /* Dewdrop */
            content: '';
            position: absolute; top: 30%; left: 45%;
            width: 5px; height: 5px;
            background-color: rgba(220, 230, 255, 0.8);
            border-radius: 50%;
            box-shadow: 0 0 5px rgba(220, 230, 255, 1);
            animation: glisten 4s ease-in-out infinite alternate;
            opacity: 0;
            animation-delay: inherit; /* Inherit delay from parent .sprout */
        }
        @keyframes glisten {
            from { opacity: 0; transform: scale(0.8); }
            to { opacity: 1; transform: scale(1); }
        }

        /* --- Aurora Theme --- */
        #aurora-theme {
            background-color: #00020c;
            overflow: hidden;
        }
        #aurora-stars {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .aurora-star {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 10s ease-in-out infinite;
        }
        .aurora-curtain {
            position: absolute;
            top: -50%; left: -25%;
            width: 150%; height: 200%;
            transform-origin: center;
            mix-blend-mode: screen;
            animation: aurora-curtain-flow 30s ease-in-out infinite alternate;
        }
        #aurora-layer-1 {
            background: radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 40%, #00ff99 100%);
            animation-duration: 25s;
            z-index: 2;
        }
        #aurora-layer-2 {
            background: radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 40%, #66ccff 100%);
            animation-duration: 20s;
            animation-direction: alternate-reverse;
            z-index: 3;
        }
        #aurora-layer-3 {
            background: radial-gradient(ellipse at center, rgba(0,0,0,0) 0%, rgba(0,0,0,0) 40%, #ff66cc 100%);
            animation-duration: 35s;
            z-index: 1;
        }
        @keyframes aurora-curtain-flow {
            0% {
                transform: rotate(0deg) scale(1) skewX(0deg) translateY(0%);
                filter: blur(5px) brightness(1);
            }
            50% {
                transform: rotate(10deg) scale(1.2) skewX(15deg) translateY(10%);
                filter: blur(10px) brightness(1.5);
            }
            100% {
                transform: rotate(-5deg) scale(0.9) skewX(-10deg) translateY(-5%);
                filter: blur(8px) brightness(1.2);
            }
        }
        
        /* --- Galaxy Theme --- */
        #galaxy-theme {
            background-color: #000005;
            overflow: hidden;
            perspective: 800px;
        }
        #galaxy-stars-bg {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
        }
        .galaxy-star-bg {
            position: absolute;
            background-color: white;
            border-radius: 50%;
            animation: twinkle 15s ease-in-out infinite;
        }
        .nebula-container {
            position: absolute;
            top: 50%; left: 50%;
            width: 100vmin; height: 100vmin;
            transform-style: preserve-3d;
            animation: slow-rotate-3d 240s linear infinite;
        }
        @keyframes slow-rotate-3d {
            from { transform: translate(-50%, -50%) rotateY(0deg) rotateX(10deg); }
            to { transform: translate(-50%, -50%) rotateY(360deg) rotateX(10deg); }
        }
        .nebula {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            border-radius: 50%;
            mix-blend-mode: screen;
            filter: blur(40px);
        }
        #nebula-layer-1 {
            background: radial-gradient(circle, #ff33cc 0%, #ff33cc 10%, rgba(0,0,0,0) 60%);
            transform: translateZ(-100px) rotateY(60deg);
            animation: nebula-pulse 20s ease-in-out infinite alternate;
        }
        #nebula-layer-2 {
            background: radial-gradient(circle, #33ccff 0%, #33ccff 10%, rgba(0,0,0,0) 50%);
            transform: translateZ(50px) rotateY(-40deg) scale(0.8);
            animation: nebula-pulse 25s ease-in-out infinite alternate-reverse;
        }
        #nebula-layer-3 {
            background: radial-gradient(circle, #9933ff 0%, #9933ff 10%, rgba(0,0,0,0) 70%);
            transform: translateZ(150px) rotateY(20deg) scale(1.2);
            animation: nebula-pulse 30s ease-in-out infinite alternate;
        }
        @keyframes nebula-pulse {
            from { opacity: 0.7; transform: scale(1); }
            to { opacity: 1; transform: scale(1.1); }
        }
        #shooting-stars {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            transform: rotate(20deg);
            z-index: 10;
        }
        .shooting-star {
            position: absolute;
            height: 1px;
            background: linear-gradient(to right, white, transparent);
            animation: shoot 10s linear infinite;
        }
        @keyframes shoot {
            from { left: -50%; transform: scaleX(0.5); opacity: 1; }
            70% { opacity: 1; }
            to { left: 150%; transform: scaleX(1); opacity: 0; }
        }

        /* --- Rainy Window Theme --- */
        #rainy-window-theme {
            background-color: #2c3e50;
            overflow: hidden;
        }
        .rainy-bg {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 800 600"><filter id="g"><feGaussianBlur stdDeviation="5"/></filter><g filter="url(%23g)"><rect x="0" y="400" width="800" height="200" fill="%2334495e"/><path d="M 100 400 L 150 200 L 200 400 Z" fill="%232c3e50"/><path d="M 300 400 L 320 300 L 340 400 Z" fill="%232c3e50"/><path d="M 500 400 L 550 100 L 600 400 Z" fill="%232c3e50"/></g></svg>');
            background-size: cover;
            filter: blur(4px);
            transform: scale(1.05);
            z-index: 1;
        }
        #rain-canvas {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            z-index: 2;
        }
        .lightning-flash {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: white;
            opacity: 0;
            z-index: 3;
            pointer-events: none;
            animation: flash-lightning 10s linear infinite;
        }
        @keyframes flash-lightning {
            0% { opacity: 0; }
            49% { opacity: 0; }
            50% { opacity: 0.7; }
            50.5% { opacity: 0.2; }
            51% { opacity: 1; }
            52% { opacity: 0; }
            100% { opacity: 0; }
        }
        
        /* --- Koi Pond Theme --- */
        #koi-pond-theme {
            background-color: #3b5249;
            overflow: hidden;
        }
        .water-surface {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: linear-gradient(175deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0) 5%);
            animation: shimmer-water 15s ease-in-out infinite alternate;
            z-index: 2;
        }
        @keyframes shimmer-water {
            from { opacity: 0.7; }
            to { opacity: 1; }
        }
        #lily-pads {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3;
        }
        .lily-pad {
            position: absolute;
            width: 100px; height: 100px;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><path d="M 50 50 C 20 100, 80 100, 50 50 M 50 50 C 0 20, 0 80, 50 50 M 50 50 C 80 0, 20 0, 50 50" fill="%232d6a4f" stroke="%231b4332" stroke-width="2"/></svg>');
            animation: float-gently 20s ease-in-out infinite alternate;
        }
        @keyframes float-gently {
            from { transform: translate(var(--x-pos), var(--y-pos)) rotate(-2deg); }
            to { transform: translate(var(--x-pos), var(--y-pos)) rotate(2deg); }
        }
        #koi-fish {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4;
        }
        .koi {
            position: absolute;
            width: 100px; height: 40px;
            background-repeat: no-repeat;
            background-position: center;
            background-size: contain;
            animation: swim-koi 25s ease-in-out infinite;
        }
        @keyframes swim-koi {
            0%   { transform: translate(var(--x1), var(--y1)) rotate(var(--r1)); }
            20%  { transform: translate(var(--x2), var(--y2)) rotate(var(--r2)); }
            40%  { transform: translate(var(--x3), var(--y3)) rotate(var(--r3)); }
            60%  { transform: translate(var(--x4), var(--y4)) rotate(var(--r4)); }
            80%  { transform: translate(var(--x5), var(--y5)) rotate(var(--r5)); }
            100% { transform: translate(var(--x1), var(--y1)) rotate(var(--r1)); }
        }
        #koi-ripples {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 5;
        }
        .koi-ripple {
            position: absolute;
            border: 1px solid rgba(200, 220, 240, 0.3);
            border-radius: 50%;
            animation: expand-ripple 3s ease-out;
            transform-origin: center;
        }
        @keyframes expand-ripple {
            from { transform: scale(0); opacity: 1; }
            to { transform: scale(1); opacity: 0; }
        }

        /* --- Meadow Theme --- */
        #meadow-theme {
            background: linear-gradient(to top, #89c2d9, #a7c957, #6a994e);
            overflow: hidden;
        }
        .meadow-sky {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(to top, #dcedc1, #a8e6cf);
            z-index: 1;
        }
        .meadow-grass {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 20%;
            z-index: 5;
        }
        .grass-blade {
            position: absolute; bottom: 0;
            width: 3px;
            background: linear-gradient(to top, #4d7c3d, #6a994e);
            border-radius: 3px 3px 0 0;
            transform-origin: bottom center;
            animation: sway 5s ease-in-out infinite alternate;
        }
        @keyframes sway {
            from { transform: rotate(-5deg); }
            to { transform: rotate(5deg); }
        }
        #meadow-pollen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4;
        }
        .pollen-particle {
            position: absolute;
            width: 4px; height: 4px;
            background-color: #f2e8cf;
            border-radius: 50%;
            animation: pollen-gust 10s ease-in-out infinite;
        }
        @keyframes pollen-gust {
            0% { transform: translate(var(--x-start), var(--y-start)) scale(1); opacity: 0; }
            25% { transform: translate(calc(var(--x-start) + var(--x-gust1)), calc(var(--y-start) - 30vh)) scale(0.8); opacity: 1; }
            50% { transform: translate(calc(var(--x-start) + var(--x-gust2)), calc(var(--y-start) - 60vh)) scale(1); opacity: 1; }
            75% { transform: translate(calc(var(--x-start) + var(--x-gust3)), calc(var(--y-start) - 90vh)) scale(0.7); opacity: 1; }
            100% { transform: translate(var(--x-end), -20vh) scale(0.5); opacity: 0; }
        }
        #meadow-butterflies {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3;
        }
        .butterfly {
            position: absolute;
            width: 30px; height: 30px;
            animation: butterfly-path 20s linear infinite;
        }
        .butterfly-wing {
            position: absolute;
            width: 50%; height: 100%;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 15 30"><path d="M 15 15 C 0 0, 0 30, 15 15" stroke="gold" fill="rgba(255,215,0,0.7)" stroke-width="2"/></svg>');
            background-size: contain;
            background-repeat: no-repeat;
            transform-origin: right center;
        }
        .butterfly-wing.left {
            left: 0;
            animation: flap-left 0.5s ease-in-out infinite alternate;
        }
        .butterfly-wing.right {
            right: 0;
            transform: scaleX(-1); /* Mirror the right wing */
            animation: flap-right 0.5s ease-in-out infinite alternate;
        }
        @keyframes butterfly-path {
            0% { transform: translate(var(--x1), var(--y1)) rotate(0deg); }
            25% { transform: translate(var(--x2), var(--y2)) rotate(15deg); }
            50% { transform: translate(var(--x3), var(--y3)) rotate(-15deg); }
            75% { transform: translate(var(--x4), var(--y4)) rotate(0deg); }
            100% { transform: translate(var(--x1), var(--y1)) rotate(0deg); }
        }
        @keyframes flap-left {
            from { transform: rotateY(0deg); }
            to { transform: rotateY(-70deg); }
        }
        @keyframes flap-right {
            from { transform: scaleX(-1) rotateY(0deg); }
            to { transform: scaleX(-1) rotateY(-70deg); }
        }

        /* --- Cosmic Chimes Theme --- */
        #cosmic-chimes-theme {
            background-color: #0c0a1a;
            overflow: hidden;
        }
        .chime-nebula {
            position: absolute; top: 0; left: 0;
            width: 100%; height: 100%;
            background: radial-gradient(ellipse at 50% 50%, rgba(100, 150, 200, 0.2) 0%, rgba(0,0,0,0) 60%);
            animation: slow-rotate-3d 180s linear infinite;
        }
        #space-dust { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; }
        .dust-particle {
            position: absolute;
            background-color: #aaddff;
            border-radius: 50%;
            animation: dust-float 30s ease-in-out infinite alternate;
        }
        @keyframes dust-float {
            from { transform: translate(var(--x-start), var(--y-start)); opacity: 0; }
            50% { opacity: 0.5; }
            to { transform: translate(var(--x-end), var(--y-end)); opacity: 0; }
        }
        .chime {
            position: absolute;
            width: 3px;
            height: 120px;
            background: linear-gradient(to bottom, rgba(255, 255, 255, 0), rgba(173, 216, 230, 0.9), rgba(255, 255, 255, 0));
            animation: shimmer-chime 12s ease-in-out infinite;
            z-index: 3;
        }
        @keyframes shimmer-chime {
            0%, 100% { opacity: 0; transform: scaleY(0.8) rotate(var(--r-start)); }
            50% { opacity: 1; transform: scaleY(1) rotate(var(--r-end)); box-shadow: 0 0 20px #ade6e6, 0 0 35px #ade6e6; }
        }

        /* --- Singing Bowl Theme --- */
        #singing-bowl-theme {
            background: radial-gradient(circle at 50% 50%, #1a1225, #0c0a1a 70%);
            overflow: hidden;
        }
        #singing-bowl-glow {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 80vmin; height: 80vmin;
            background: radial-gradient(circle, rgba(180, 160, 220, 0.1) 0%, rgba(0,0,0,0) 70%);
            animation: slow-pulse 10s ease-in-out infinite alternate;
        }
        .singing-bowl-silhouette {
            position: absolute; bottom: 0; left: 50%;
            transform: translateX(-50%);
            width: 60vmin; height: 30vmin;
            background-image: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 100"><path d="M 0 100 L 200 100 L 180 20 C 150 0, 50 0, 20 20 Z" fill="rgba(0,0,0,0.4)"/></svg>');
            background-size: 100% 100%;
            z-index: 2;
        }
        #bowl-ripples { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 3; }
        .bowl-ripple {
            position: absolute;
            border: 2px solid rgba(200, 180, 220, 0.6);
            border-radius: 50%;
            animation: bowl-ripple-effect 8s ease-out infinite;
        }
        @keyframes bowl-ripple-effect {
            from { top: 60%; width: 0; height: 0; opacity: 1; }
            to { top: 40%; width: 100vmin; height: 100vmin; opacity: 0; }
        }
        #bowl-motes { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 4; }
        .bowl-mote {
            position: absolute;
            background-color: rgba(220, 200, 240, 0.8);
            border-radius: 50%;
            animation: mote-rise 15s ease-in infinite;
        }
        @keyframes mote-rise {
            from { transform: translateY(80vh) scale(1); opacity: 1; }
            to { transform: translateY(30vh) scale(0.5); opacity: 0; }
        }


        /* --- Starlight Theme --- */
        #starlight-theme {
            background-color: #0c0a1a;
            overflow: hidden;
        }
        #starlight-nebula {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: radial-gradient(ellipse at 50% 50%, rgba(100, 120, 180, 0.15) 0%, rgba(0,0,0,0) 70%);
            animation: slow-rotate-3d 300s linear infinite;
        }
        .starlight-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        #starlights-back { transform: translateZ(-200px) scale(1.5); filter: blur(1px); opacity: 0.7; }
        #starlights-mid { transform: translateZ(-100px) scale(1.2); }
        #starlights-front { transform: translateZ(0px) scale(1); }
        .starlight {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: starlight-pulse-deep 8s ease-in-out infinite alternate;
        }
        @keyframes starlight-pulse-deep {
            from {
                opacity: 0.5;
                transform: scale(0.8);
                box-shadow: 0 0 5px #fff, 0 0 10px #fff, 0 0 15px #adc8ff;
            }
            to {
                opacity: 1;
                transform: scale(1.1);
                box-shadow: 0 0 10px #fff, 0 0 20px #fff, 0 0 30px #adc8ff;
            }
        }

        /* --- Swedish Forest Theme --- */
        #swedish-forest-theme {
            background: linear-gradient(to top, #0a141a, #1a2a3a);
            overflow: hidden;
        }
        .sf-parallax {
            position: absolute;
            bottom: 0; left: 0;
            width: 200%; height: 100%;
            background-repeat: repeat-x;
            background-position: 0 bottom;
        }
        #sf-layer-1 { animation: slide 240s linear infinite; z-index: 1; }
        #sf-layer-2 { animation: slide 180s linear infinite; z-index: 3; }
        #sf-layer-3 { animation: slide 120s linear infinite; z-index: 5; }

        .god-ray-container {
            position: absolute; top: -10%; left: 0;
            width: 100%; height: 110%;
            animation: god-ray-anim 60s ease-in-out infinite alternate;
            transform-origin: center top;
            z-index: 2;
        }
        .god-ray {
            position: absolute; top: 0;
            background: linear-gradient(to bottom, rgba(255, 255, 220, 0.15) 0%, rgba(255, 255, 220, 0) 70%);
            transform-origin: top center;
        }
        @keyframes god-ray-anim {
            from { transform: rotate(-10deg); }
            to { transform: rotate(10deg); }
        }

        .mist {
            position: absolute;
            bottom: 0; left: 0;
            width: 200%; height: 25%;
            background: linear-gradient(to top, rgba(150, 160, 170, 0.2) 0%, rgba(150, 160, 170, 0) 100%);
            animation: mist-anim 90s linear infinite;
            z-index: 4;
        }
        @keyframes mist-anim {
            from { transform: translateX(0%); }
            to { transform: translateX(-50%); }
        }

        .forest-spirit {
            position: absolute;
            width: 15px;
            height: 15px;
            background-color: rgba(180, 220, 255, 0.5);
            border-radius: 50%;
            box-shadow: 0 0 10px rgba(180, 220, 255, 0.7), 0 0 20px rgba(180, 220, 255, 0.5);
            animation: spirit-drift 25s ease-in-out infinite alternate;
            z-index: 6;
        }

        @keyframes spirit-drift {
            from {
                transform: translate(var(--x-start), var(--y-start)) scale(1);
                opacity: 0.7;
            }
            to {
                transform: translate(var(--x-end), var(--y-end)) scale(1.2);
                opacity: 0.9;
            }
        }


        @keyframes slide {
            from { background-position-x: 0; }
            to { background-position-x: -800px; }
        }

        .game-container {
            display: flex;
            gap: 30px;
            padding: 20px;
            animation: fadeIn 0.5s ease;
            position: relative;
            z-index: 1;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }

        .game-area { display: flex; flex-direction: column; align-items: center; gap: 15px; }
        .next-pieces-container {
            display: flex; gap: 15px; align-items: flex-end; padding: 15px;
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px);
            border: 2px solid #8b5cf6; border-radius: 12px; min-height: 80px;
        }
        .next-piece-box { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .next-piece-box.main { transform: scale(1.2); margin-right: 10px; }
        .next-piece-label { font-size: 10px; color: #a78bfa; text-transform: uppercase; font-weight: bold; }
        .next-piece-box canvas { background: rgba(0, 0, 0, 0.3); border-radius: 6px; padding: 4px; border: 1px solid rgba(139, 92, 246, 0.3); }
        .next-piece-box.main canvas { border: 2px solid rgba(0, 255, 255, 0.5); box-shadow: 0 0 10px rgba(0, 255, 255, 0.3); }

        #game-canvas {
            border: 4px solid #8b5cf6;
            border-radius: 12px;
            background: rgba(26, 26, 46, 0.8);
            box-shadow: 0 0 30px rgba(139, 92, 246, 0.5), 0 0 60px rgba(139, 92, 246, 0.3), 0 0 90px rgba(139, 92, 246, 0.1);
        }

        .sidebar { display: flex; flex-direction: column; gap: 20px; }
        .panel {
            background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(10px); border: 2px solid #8b5cf6;
            border-radius: 12px; padding: 20px; min-width: 180px; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }
        .panel h2 {
            font-family: 'Orbitron', sans-serif; font-weight: 700; color: #00ffff; font-size: 18px;
            margin-bottom: 15px; text-align: center; text-shadow: 0 0 10px rgba(0, 255, 255, 0.5);
        }
        .stat-row { display: flex; justify-content: space-between; margin-bottom: 10px; font-size: 14px; }
        .stat-label { color: #a78bfa; font-weight: 400; }
        .stat-value { color: #ffffff; font-weight: 700; }
        .stat-value.danger { color: #ef4444; text-shadow: 0 0 5px rgba(239, 68, 68, 0.5); animation: pulse 0.5s infinite; }
        .stat-value.warning { color: #fbbf24; text-shadow: 0 0 5px rgba(251, 191, 36, 0.5); }
        .controls-info { font-size: 12px; color: #a78bfa; }
        .controls-info div { margin-bottom: 5px; }
        .action-btn {
            background: #8b5cf6; border: none; color: white; padding: 10px; border-radius: 8px;
            cursor: pointer; font-size: 16px; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(139, 92, 246, 0.4);
            text-align: center;
        }
        .action-btn:hover { background: #7c3aed; transform: translateY(-2px); box-shadow: 0 6px 20px rgba(139, 92, 246, 0.6); }

        .modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; justify-content: center; align-items: center; background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px); opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000;
        }
        .modal.visible { opacity: 1; visibility: visible; }
        .modal-content {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.2), rgba(0, 255, 255, 0.1)); border: 3px solid;
            border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 0 50px rgba(139, 92, 246, 0.5); color: #e0e7ff;
        }
        .modal h1 {
            font-family: 'Orbitron', sans-serif; font-weight: 900; font-size: 48px;
            margin-bottom: 20px; text-shadow: 0 0 20px currentColor;
        }
        #start-modal .modal-content { border-color: #00ffff; }
        #start-modal h1 { background: linear-gradient(45deg, #00ffff, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
        #game-over-modal .modal-content, #settings-modal .modal-content { border-color: #8b5cf6; }
        #game-over-modal h1, #settings-modal h1 { color: #00ffff; }
        .modal p { font-size: 18px; animation: pulse 2s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; } 50% { opacity: 0.5; }
        }
        
        .settings-grid { display: grid; grid-template-columns: auto 1fr; gap: 15px 20px; margin: 20px 0; text-align: left; align-items: center; }
        .setting { display: contents; }
        .setting label { justify-self: end; align-self: center; }
        .key-input, .setting-select {
            background: rgba(0,0,0,0.3); border: 1px solid #8b5cf6; color: white; padding: 8px; border-radius: 5px;
            text-align: center; cursor: pointer; width: 150px; justify-self: start;
        }
        .setting-select {
            text-align: left; -webkit-appearance: none; -moz-appearance: none; appearance: none;
            padding-right: 30px; 
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat; background-position: right 8px center; background-size: 1em;
        }
        .key-input.listening { border-color: #fbbf24; box-shadow: 0 0 10px #fbbf24; }
        .slider-container { display: flex; align-items: center; gap: 10px; }
        .slider-container input[type=range] { -webkit-appearance: none; appearance: none; width: 100%; cursor: pointer; background: transparent; }
        .slider-container input[type=range]::-webkit-slider-runnable-track { background: rgba(0,0,0,0.5); height: 8px; border-radius: 4px; }
        .slider-container input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; appearance: none; margin-top: -4px;
            background-color: #8b5cf6; height: 16px; width: 16px; border-radius: 50%;
        }

        .score-popup { position: absolute; color: #fbbf24; font-weight: bold; font-size: 24px; pointer-events: none; animation: scorePop 1s ease-out forwards; }
        @keyframes scorePop {
            0% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
            100% { transform: translate(-50%, -150%) scale(1.5); opacity: 0; }
        }

        .line-flash { animation: flash 0.5s ease; }
        @keyframes flash {
            0%, 100% { filter: brightness(1); } 50% { filter: brightness(2); }
        }

        @media (max-width: 768px) {
            .game-container { flex-direction: column; align-items: center; transform: scale(0.8); }
            .game-area { order: -1; }
            .next-pieces-container { flex-wrap: wrap; max-width: 300px; }
        }
    </style>
</head>
<body>
    <div class="background-container">
        <div id="stars"></div>
        
        <div id="forest-theme" class="theme-container">
            <div class="forest-moon"></div>
            <div id="enchanted-forest-back" class="enchanted-forest-layer"></div>
            <div class="forest-mist"></div>
            <div id="enchanted-forest-mid" class="enchanted-forest-layer"></div>
            <div id="fireflies"></div>
            <div id="enchanted-forest-front" class="enchanted-forest-layer"></div>
        </div>
        <div id="ocean-theme" class="theme-container">
            <div class="caustics-container"></div>
            <div class="sea-creature-container"></div>
            <div id="ocean-floor-bg" class="ocean-parallax"></div>
            <div id="ocean-floor-mid" class="ocean-parallax"></div>
            <div id="ocean-floor-fg" class="ocean-parallax"></div>
            <div id="bubbles"></div>
        </div>
        <div id="sunset-theme" class="theme-container">
            <div class="sun-and-sky">
                <div class="sun"></div>
                <div class="lens-flare"></div>
            </div>
            <div id="sunset-clouds-back" class="sunset-clouds"></div>
            <div id="sunset-clouds-mid" class="sunset-clouds"></div>
            <div id="dust-motes"></div>
            <div id="sunset-clouds-front" class="sunset-clouds"></div>
        </div>
        <div id="zen-theme" class="theme-container">
            <div class="raked-sand"></div>
            <div class="water-feature">
                <div class="zen-ripple"></div>
            </div>
            <div id="petals"></div>
        </div>
        <div id="winter-theme" class="theme-container">
            <div id="snowflakes-back" class="snowflakes-layer"></div>
            <div id="snowflakes-mid" class="snowflakes-layer"></div>
            <div id="snowflakes-front" class="snowflakes-layer"></div>
            <div class="window-pane">
                <div class="frost-overlay"></div>
                <div class="ice-crystals"></div>
            </div>
        </div>
        <div id="fall-theme" class="theme-container">
            <div class="fall-bg"></div>
            <div id="fall-leaves-back" class="fall-leaves-layer"></div>
            <div id="fall-leaves-mid" class="fall-leaves-layer"></div>
            <div id="fall-leaves-front" class="fall-leaves-layer"></div>
            <div class="ground-leaves"></div>
        </div>
        <div id="summer-theme" class="theme-container">
            <div class="summer-sky"></div>
            <div class="god-rays-summer"></div>
            <div id="dandelion-seeds"></div>
            <div class="heat-haze"></div>
        </div>
        <div id="spring-theme" class="theme-container">
            <div id="spring-rain"></div>
            <div class="spring-ground"></div>
            <div id="sprouts-container"></div>
        </div>
        <div id="aurora-theme" class="theme-container">
            <div id="aurora-stars"></div>
            <div class="aurora-curtain" id="aurora-layer-1"></div>
            <div class="aurora-curtain" id="aurora-layer-2"></div>
            <div class="aurora-curtain" id="aurora-layer-3"></div>
        </div>
        <div id="galaxy-theme" class="theme-container">
            <div id="galaxy-stars-bg"></div>
            <div class="nebula-container">
                <div class="nebula" id="nebula-layer-1"></div>
                <div class="nebula" id="nebula-layer-2"></div>
                <div class="nebula" id="nebula-layer-3"></div>
            </div>
            <div id="shooting-stars"></div>
        </div>
        <div id="rainy-window-theme" class="theme-container">
            <div class="rainy-bg"></div>
            <canvas id="rain-canvas"></canvas>
            <div class="lightning-flash"></div>
        </div>
        <div id="koi-pond-theme" class="theme-container">
            <div class="water-surface"></div>
            <div id="lily-pads"></div>
            <div id="koi-fish"></div>
            <div id="koi-ripples"></div>
        </div>
        <div id="meadow-theme" class="theme-container">
            <div class="meadow-sky"></div>
            <div id="meadow-pollen"></div>
            <div id="meadow-butterflies"></div>
            <div class="meadow-grass"></div>
        </div>
        <div id="cosmic-chimes-theme" class="theme-container">
            <div class="chime-nebula"></div>
            <div id="space-dust"></div>
            <div id="chimes"></div>
        </div>
        <div id="singing-bowl-theme" class="theme-container">
            <div id="singing-bowl-glow"></div>
            <div class="singing-bowl-silhouette"></div>
            <div id="bowl-ripples"></div>
            <div id="bowl-motes"></div>
        </div>
        <div id="starlight-theme" class="theme-container">
            <div id="starlight-nebula"></div>
            <div id="starlights-back" class="starlight-layer"></div>
            <div id="starlights-mid" class="starlight-layer"></div>
            <div id="starlights-front" class="starlight-layer"></div>
        </div>
        <div id="swedish-forest-theme" class="theme-container">
            <div id="sf-layer-1" class="sf-parallax"></div>
            <div class="god-ray-container"></div>
            <div id="sf-layer-2" class="sf-parallax"></div>
            <div class="mist"></div>
            <div id="sf-layer-3" class="sf-parallax"></div>
            <div id="forest-spirits"></div>
        </div>
    </div>

    <div class="game-container">
        <div class="sidebar">
            <div class="panel">
                <h2>STATS</h2>
                <div class="stat-row"><span class="stat-label">SCORE</span><span id="score" class="stat-value">0</span></div>
                <div class="stat-row"><span class="stat-label">LINES</span><span id="lines" class="stat-value">0</span></div>
                <div class="stat-row"><span class="stat-label">LEVEL</span><span id="level" class="stat-value">1</span></div>
                <div class="stat-row"><span class="stat-label">NEXT LVL</span><span id="next-level" class="stat-value">10</span></div>
                <div class="stat-row"><span class="stat-label">SPEED</span><span id="speed" class="stat-value">1.0x</span></div>
                <div class="stat-row"><span class="stat-label">BPM</span><span id="bpm" class="stat-value">0</span></div>
            </div>
            <div class="panel">
                <h2>CONTROLS</h2>
                <div class="controls-info"><div id="controls-list"></div></div>
            </div>
            <button id="sound-toggle" class="action-btn">🔊</button>
            <button id="next-track-btn" class="action-btn">🎵</button>
            <button id="fullscreen-toggle" class="action-btn">⛶</button>
            <button id="settings-btn" class="action-btn">⚙️</button>
        </div>
        <div class="game-area">
            <div class="next-pieces-container">
                <div class="next-piece-box main"><span class="next-piece-label">Next</span><canvas id="next-0" width="60" height="50"></canvas></div>
                <div class="next-piece-box"><canvas id="next-1" width="50" height="40"></canvas></div>
                <div class="next-piece-box"><canvas id="next-2" width="50" height="40"></canvas></div>
                <div class="next-piece-box"><canvas id="next-3" width="50" height="40"></canvas></div>
                <div class="next-piece-box"><canvas id="next-4" width="50" height="40"></canvas></div>
            </div>
            <div style="position: relative;">
                <canvas id="game-canvas"></canvas>
                <div id="score-popups"></div>
            </div>
        </div>
    </div>

    <div id="start-modal" class="modal visible">
        <div class="modal-content">
            <h1>QUADRA</h1>
            <p>Press any key to start</p>
        </div>
    </div>
    <div id="game-over-modal" class="modal">
        <div class="modal-content">
            <h1>The cycle ends.</h1>
            <div id="final-stats"></div>
            <p>Press any key to restart</p>
        </div>
    </div>
    <div id="settings-modal" class="modal">
        <div class="modal-content">
            <h1>SETTINGS</h1>
            <div class="settings-grid">
                <div class="setting">
                    <label for="das-delay">DAS Delay (ms):</label>
                    <div class="slider-container">
                        <input type="range" id="das-delay" min="50" max="300" step="10"><span id="das-delay-value">150</span>
                    </div>
                </div>
                <div class="setting">
                    <label for="das-interval">DAS Interval (ms):</label>
                    <div class="slider-container">
                        <input type="range" id="das-interval" min="10" max="100" step="5"><span id="das-interval-value">50</span>
                    </div>
                </div>
                <div class="setting">
                    <label for="music-track">Music Track:</label>
                    <select id="music-track" class="setting-select">
                        <option value="Ambient">Ambient (Relax)</option>
                        <option value="Decay">Decay (Meditate)</option>
                        <option value="Zen">Zen (Calm)</option>
                        <option value="Nostalgia">Nostalgia (Focus)</option>
                        <option value="Nebula">Nebula (Modern)</option>
                        <option value="Classic">Classic</option>
                        <option value="Aurora">Aurora</option>
                        <option value="Galaxy">Galaxy</option>
                        <option value="Rainfall">Rainfall</option>
                        <option value="Koi">Koi</option>
                        <option value="Meadow">Meadow</option>
                        <option value="MiracleTone">Miracle Tone (528Hz)</option>
                        <option value="HealingDrone">Healing Drone (174Hz)</option>
                        <option value="CosmicChimes">Cosmic Chimes (Ethereal)</option>
                        <option value="SingingBowl">Singing Bowl (Deep)</option>
                        <option value="Starlight">Starlight (Gentle)</option>
                        <option value="SwedishForest">Swedish Forest (Deep)</option>
                    </select>
                </div>
                <div class="setting">
                    <label for="sfx-set">Sound Effects:</label>
                    <select id="sfx-set" class="setting-select">
                        <option value="Zen">Zen</option>
                        <option value="Retro">Retro</option>
                    </select>
                </div>
                 <div class="setting">
                    <label for="background-mode">Background:</label>
                    <select id="background-mode" class="setting-select">
                        <option value="Level">Level Transition</option>
                        <option value="Random">Random Transition</option>
                        <option value="Specific">Set Specific</option>
                    </select>
                </div>
                <div class="setting" id="theme-setting">
                    <label for="background-theme">Theme:</label>
                    <select id="background-theme" class="setting-select">
                        <option value="forest">Forest</option>
                        <option value="ocean">Ocean</option>
                        <option value="sunset">Sunset</option>
                        <option value="zen">Zen</option>
                        <option value="winter">Winter</option>
                        <option value="fall">Fall</option>
                        <option value="summer">Summer</option>
                        <option value="spring">Spring</option>
                        <option value="aurora">Aurora</option>
                        <option value="galaxy">Galaxy</option>
                        <option value="rainy-window">Rainy Window</option>
                        <option value="koi-pond">Koi Pond</option>
                        <option value="meadow">Meadow</option>
                        <option value="cosmic-chimes">Cosmic Chimes</option>
                        <option value="singing-bowl">Singing Bowl</option>
                        <option value="starlight">Starlight</option>
                        <option value="swedish-forest">Swedish Forest</option>
                    </select>
                </div>
                <div class="setting"><label>Move Left:</label> <div id="key-moveLeft" class="key-input" tabindex="0">ArrowLeft</div></div>
                <div class="setting"><label>Move Right:</label> <div id="key-moveRight" class="key-input" tabindex="0">ArrowRight</div></div>
                <div class="setting"><label>Rotate Right:</label> <div id="key-rotateRight" class="key-input" tabindex="0">ArrowUp</div></div>
                <div class="setting"><label>Rotate Left:</label> <div id="key-rotateLeft" class="key-input" tabindex="0">z</div></div>
                <div class="setting"><label>Flip (180°):</label> <div id="key-flip" class="key-input" tabindex="0">a</div></div>
                <div class="setting"><label>Soft Drop:</label> <div id="key-softDrop" class="key-input" tabindex="0">ArrowDown</div></div>
                <div class="setting"><label>Hard Drop:</label> <div id="key-hardDrop" class="key-input" tabindex="0">Space</div></div>
                <div class="setting"><label>Toggle Music:</label> <div id="key-toggleMusic" class="key-input" tabindex="0">M</div></div>
            </div>
            <button id="close-settings" class="action-btn">Close</button>
        </div>
    </div>

    <script>
        class SoundManager {
            constructor() {
                this.audioContext = null; this.isMuted = false; this.musicInterval = null;
                this.musicTrack = 'Ambient'; this.soundSet = 'Zen';
                this.currentTrackId = null;
                this.trackNames = [
                    'Ambient', 'Decay', 'Zen', 'Nostalgia', 'Nebula', 'Classic', 'Aurora',
                    'Galaxy', 'Rainfall', 'Koi', 'Meadow', 'MiracleTone', 'HealingDrone',
                    'CosmicChimes', 'SingingBowl', 'Starlight', 'SwedishForest'
                ];
                this.soundSets = {
                    Retro: {
                        move: () => this.createTone(200, 0.05, 'square', 0.2),
                        rotate: () => this.createTone(400, 0.08, 'triangle', 0.3),
                        drop: () => this.createTone(120, 0.1, 'sine', 0.4),
                        lineClear: () => [523, 659, 784, 1047].forEach((f, i) => setTimeout(() => this.createTone(f, 0.2, 'sine', 0.4), i*50)),
                        levelUp: () => [261, 329, 392, 523, 659].forEach((f, i) => setTimeout(() => this.createTone(f, 0.15, 'sine', 0.5), i*60)),
                        gameOver: () => [400, 350, 300, 250, 200].forEach((f, i) => setTimeout(() => this.createTone(f, 0.3, 'sawtooth', 0.5), i*150))
                    },
                    Zen: {
                        move: () => this.createTone(100, 0.1, 'sine', 0.1),
                        rotate: () => this.createTone(150, 0.1, 'sine', 0.15),
                        drop: () => this.createTone(80, 0.2, 'sine', 0.2),
                        lineClear: () => [261, 329, 392].forEach((f, i) => setTimeout(() => this.createTone(f, 0.5, 'sine', 0.15), i*80)),
                        levelUp: () => [392, 493, 587].forEach((f, i) => setTimeout(() => this.createTone(f, 0.6, 'sine', 0.2), i*100)),
                        gameOver: () => [220, 164, 130].forEach((f, i) => setTimeout(() => this.createTone(f, 0.8, 'sine', 0.2), i*200))
                    }
                };
            }
            init() { if (!this.audioContext) this.audioContext = new (window.AudioContext || window.webkitAudioContext)(); }
            createTone(frequency, duration = 0.1, type = 'sine', volume = 0.3, onended = null) {
                if (!this.audioContext || this.isMuted) return;
                const osc = this.audioContext.createOscillator(), gain = this.audioContext.createGain();
                osc.connect(gain); gain.connect(this.audioContext.destination);
                osc.type = type; osc.frequency.setValueAtTime(frequency, this.audioContext.currentTime);
                gain.gain.setValueAtTime(volume, this.audioContext.currentTime);
                gain.gain.exponentialRampToValueAtTime(0.001, this.audioContext.currentTime + duration);
                osc.start(); osc.stop(this.audioContext.currentTime + duration);
                if (onended) osc.onended = onended;
            }
            setTrack(trackName) {
                if (!this.trackNames.includes(trackName)) return;
                this.musicTrack = trackName;
                settings.musicTrack = trackName;
                saveSettings();
                document.getElementById('music-track').value = trackName;
                this.stopBackgroundMusic();
                if (!this.isMuted) this.startBackgroundMusic();
            }

            nextTrack() {
                const currentIndex = this.trackNames.indexOf(this.musicTrack);
                const nextIndex = (currentIndex + 1) % this.trackNames.length;
                this.setTrack(this.trackNames[nextIndex]);
            }
            setSoundSet(setName) { this.soundSet = setName; }
            playMove() { this.soundSets[this.soundSet].move(); }
            playRotate() { this.soundSets[this.soundSet].rotate(); }
            playDrop() { this.soundSets[this.soundSet].drop(); }
            playLineClear() { this.soundSets[this.soundSet].lineClear(); }
            playLevelUp() { this.soundSets[this.soundSet].levelUp(); }
            playGameOver() { this.soundSets[this.soundSet].gameOver(); }
            startBackgroundMusic() {
                if (this.isMuted) return;
                this.stopBackgroundMusic();
                this.currentTrackId = Symbol();
                const trackId = this.currentTrackId;
                const tracks = {
                    Classic: () => this.startClassicMusic(trackId), Ambient: () => this.startAmbientMusic(trackId),
                    Decay: () => this.startDecayMusic(trackId), Nostalgia: () => this.startNostalgiaMusic(trackId),
                    Zen: () => this.startZenMusic(trackId), Nebula: () => this.startNebulaMusic(trackId),
                    Aurora: () => this.startAuroraMusic(trackId), Galaxy: () => this.startGalaxyMusic(trackId),
                    Rainfall: () => this.startRainfallMusic(trackId), Koi: () => this.startKoiMusic(trackId),
                    Meadow: () => this.startMeadowMusic(trackId), MiracleTone: () => this.startMiracleToneMusic(trackId),
                    HealingDrone: () => this.startHealingDroneMusic(trackId),
                    CosmicChimes: () => this.startCosmicChimesMusic(trackId),
                    SingingBowl: () => this.startSingingBowlMusic(trackId),
                    Starlight: () => this.startStarlightMusic(trackId),
                    SwedishForest: () => this.startSwedishForestMusic(trackId)
                };
                (tracks[this.musicTrack] || tracks.Nebula)(trackId);
            }
            startNebulaMusic(trackId) {
                const b = [65, 73, 82, 73], m = [262, 294, 330, 349, 392, 440, 494, 523]; let bi=0, mi=0;
                const interval = setInterval(() => { if (this.isMuted || trackId !== this.currentTrackId) { clearInterval(interval); return; } this.createTone(b[bi++ % b.length], 0.4, 'triangle', 0.1); if (bi % 2 === 0) this.createTone(m[mi++ % m.length], 0.2, 'sine', 0.15); }, 250);
                this.musicInterval = interval;
            }
            startClassicMusic(trackId) {
                const m=[659, 494, 523, 587, 523, 494, 440, 440, 523, 659, 587, 523, 494, 494, 523, 587, 659, 523, 440, 440], h=[220, 261, 329]; let mi=0, hi=0;
                const interval = setInterval(() => { if (this.isMuted || trackId !== this.currentTrackId) { clearInterval(interval); return; } this.createTone(m[mi++ % m.length], 0.15, 'square', 0.2); if(mi%2===0)this.createTone(h[hi++%h.length],0.15,'sawtooth',0.05);}, 150);
                this.musicInterval = interval;
            }
            startAmbientMusic(trackId) {
                const s=[261, 311, 349, 392, 466], d=130;
                const interval = setInterval(() => { if (this.isMuted || trackId !== this.currentTrackId) { clearInterval(interval); return; } this.createTone(s[~~(Math.random()*s.length)], 0.8, 'sine', 0.15); if(Math.random()>0.7)this.createTone(s[~~(Math.random()*s.length)]/2,1.2,'sine',0.1); if(Math.random()>0.9)this.createTone(d,2.5,'sine',0.08); }, 900);
                this.musicInterval = interval;
            }
            startDecayMusic(trackId) {
                const n=[220, 277.18, 329.63];
                const interval = setInterval(() => { if (this.isMuted || trackId !== this.currentTrackId) { clearInterval(interval); return; } const note=n[~~(Math.random()*n.length)]; this.createTone(note*(1+(Math.random()-0.5)*0.005), 4, 'sine', Math.random()*0.05+0.05); }, 2000+Math.random()*2000);
                this.musicInterval = interval;
            }
            startNostalgiaMusic(trackId) {
                const m=[293.66, 329.63, 293.66, 220, 146.83]; let mi=0;
                const interval = setInterval(() => { if (this.isMuted || trackId !== this.currentTrackId) { clearInterval(interval); return; } const n=m[mi++ % m.length]; this.createTone(n, 2.5, 'triangle', 0.1); if(Math.random()>0.6) this.createTone(n*2,2.5,'sine',0.05); }, 1500);
                this.musicInterval = interval;
            }
            startZenMusic(trackId) {
                const scale = [261.63, 392.00, 440.00, 523.25], drone = 110;
                const interval = setInterval(() => {
                    if (this.isMuted || trackId !== this.currentTrackId) { clearInterval(interval); return; }
                    if (Math.random() > 0.8) this.createTone(drone, 10, 'sine', 0.05);
                    if (Math.random() > 0.7) this.createTone(scale[~~(Math.random()*scale.length)], 3, 'sine', 0.1);
                }, 4000);
                 this.musicInterval = interval;
            }
             startAuroraMusic(trackId) {
                const play = () => { if (this.isMuted || trackId !== this.currentTrackId) return; this.createTone(Math.random() * 100 + 80, 8, 'sine', Math.random() * 0.1, play); };
                play();
            }
            startGalaxyMusic(trackId) {
                const playDrone = () => { if(this.isMuted || trackId !== this.currentTrackId) return; this.createTone(55, 15, 'sawtooth', 0.03, playDrone); };
                const playSparkles = () => { if(this.isMuted || trackId !== this.currentTrackId) return; this.createTone(Math.random() * 1000 + 1000, 0.1, 'triangle', Math.random() * 0.05); setTimeout(playSparkles, Math.random() * 2000 + 500); };
                playDrone(); playSparkles();
            }
            startRainfallMusic(trackId) {
                const notes = [523, 587, 659, 784]; let idx = 0;
                const playNote = () => { if(this.isMuted || trackId !== this.currentTrackId) return; this.createTone(notes[idx % notes.length], 0.5, 'sine', 0.1); idx++; setTimeout(playNote, Math.random() * 800 + 400); };
                playNote();
            }
            startKoiMusic(trackId) {
                const scale = [261, 329, 392, 523, 587];
                const playPluck = () => { if(this.isMuted || trackId !== this.currentTrackId) return; this.createTone(scale[~~(Math.random()*scale.length)], 1.5, 'triangle', 0.15); setTimeout(playPluck, Math.random() * 2000 + 1000); };
                playPluck();
            }
            startMeadowMusic(trackId) {
                const padScale = [130.81, 196.00, 261.63]; 
                const bellScale = [523.25, 659.25, 783.99];
                const playPad = () => { if(this.isMuted || trackId !== this.currentTrackId) return; this.createTone(padScale[~~(Math.random()*padScale.length)], 12, 'sine', 0.1, playPad); };
                const playBell = () => { if(this.isMuted || trackId !== this.currentTrackId) return; if(Math.random() > 0.6) this.createTone(bellScale[~~(Math.random()*bellScale.length)], 3, 'sine', 0.08); setTimeout(playBell, Math.random() * 5000 + 3000); };
                playPad(); playBell();
            }
            startMiracleToneMusic(trackId) {
                const play = () => {
                    if (this.isMuted || trackId !== this.currentTrackId) return;
                    this.createTone(528, 10, 'sine', 0.1);
                    this.createTone(264, 10, 'sine', 0.05);
                    setTimeout(() => { if (!this.isMuted && trackId === this.currentTrackId) play(); }, 12000);
                };
                play();
            }
            startHealingDroneMusic(trackId) {
                const play = () => { if (this.isMuted || trackId !== this.currentTrackId) return; this.createTone(174, 15, 'sine', 0.15, play); };
                play();
            }

            startCosmicChimesMusic(trackId) {
                const scale = [880, 932.33, 1046.50, 1174.66, 1318.51];
                const playChime = () => {
                    if (this.isMuted || trackId !== this.currentTrackId) return;
                    const freq = scale[~~(Math.random() * scale.length)];
                    this.createTone(freq, 4, 'triangle', Math.random() * 0.08 + 0.02);
                    setTimeout(playChime, Math.random() * 5000 + 3000);
                };
                playChime();
            }

            startSingingBowlMusic(trackId) {
                const drone = 82.41;
                const strikeNote = 329.63;
                const playDrone = () => {
                    if(this.isMuted || trackId !== this.currentTrackId) return;
                    this.createTone(drone, 15, 'sine', 0.1, playDrone);
                };
                const playStrike = () => {
                    if(this.isMuted || trackId !== this.currentTrackId) return;
                    this.createTone(strikeNote, 8, 'sine', 0.1);
                    this.createTone(strikeNote * 2, 8, 'sine', 0.05);
                    setTimeout(playStrike, Math.random() * 15000 + 10000);
                };
                playDrone();
                playStrike();
            }

            startStarlightMusic(trackId) {
                const scale = [1046.50, 1174.66, 1318.51, 1396.91, 1567.98];
                const playNote = () => {
                    if (this.isMuted || trackId !== this.currentTrackId) return;
                    const note = scale[~~(Math.random() * scale.length)];
                    this.createTone(note, 2, 'triangle', Math.random() * 0.1 + 0.05);
                    if (Math.random() > 0.8) {
                        this.createTone(note / 2, 3, 'sine', 0.05);
                    }
                    setTimeout(playNote, Math.random() * 3000 + 1500);
                };
                playNote();
            }

            startSwedishForestMusic(trackId) {
                const droneFreq = 60;
                const playDrone = () => {
                    if(this.isMuted || trackId !== this.currentTrackId) return;
                    this.createTone(droneFreq, 20, 'sawtooth', 0.04, playDrone);
                };

                const playWind = () => {
                    if (this.isMuted || trackId !== this.currentTrackId) return;
                    for (let i = 0; i < 5; i++) {
                        this.createTone(80 + Math.random() * 40, 2 + Math.random() * 3, 'sine', 0.005 + Math.random() * 0.01);
                    }
                    setTimeout(playWind, Math.random() * 4000 + 2000);
                };

                const scale = [392.00, 440.00, 587.33, 659.25];
                const playTones = () => {
                    if (this.isMuted || trackId !== this.currentTrackId) return;
                    if (Math.random() > 0.6) {
                        const note = scale[~~(Math.random() * scale.length)];
                        this.createTone(note, 5, 'triangle', 0.08);
                        if (Math.random() > 0.5) { this.createTone(note/2, 5, 'sine', 0.04); }
                    }
                    setTimeout(playTones, Math.random() * 8000 + 5000);
                };

                playDrone();
                playWind();
                playTones();
            }

            stopBackgroundMusic() { 
                this.currentTrackId = null;
                if (this.musicInterval) {
                    clearInterval(this.musicInterval);
                    this.musicInterval = null;
                }
            }
            toggleMute() { this.isMuted = !this.isMuted; this.isMuted ? this.stopBackgroundMusic() : this.startBackgroundMusic(); return this.isMuted; }
        }

        const COLS = 10, ROWS = 20, HIDDEN_ROWS = 4;
        let BLOCK_SIZE = 30;
        const COLORS = { I: '#00ff00', O: '#ff9900', T: '#0000ff', S: '#00ffff', Z: '#ff0000', J: '#ffff00', L: '#cc00cc' };
        const SHAPES = { I: [[0,0,0,0],[1,1,1,1],[0,0,0,0],[0,0,0,0]], O: [[1,1],[1,1]], T: [[0,0,0],[1,1,1],[0,1,0]], S: [[0,1,1],[1,1,0],[0,0,0]], Z: [[1,1,0],[0,1,1],[0,0,0]], J: [[0,0,0],[1,1,1],[0,0,1]], L: [[0,0,0],[1,1,1],[1,0,0]] };
        const PIECE_KEYS = 'IOTZSLJ', SCORE_VALUES = { 1: 100, 2: 300, 3: 500, 4: 800 };
        const LEVEL_SPEEDS = [ 1000, 850, 700, 550, 400, 300, 200, 150, 100, 80, 60, 50, 40, 35, 30 ];
        const THEMES = ['forest', 'ocean', 'sunset', 'zen', 'winter', 'fall', 'summer', 'spring', 'aurora', 'galaxy', 'rainy-window', 'koi-pond', 'meadow', 'cosmic-chimes', 'singing-bowl', 'starlight', 'swedish-forest'];

        let canvas, ctx, nextCanvases = [], board, lockedPieces = [], currentPiece = null;
        let nextPieces = [], score = 0, lines = 0, level = 1, dropInterval = 1000;
        let dropCounter = 0, lastTime = 0, startTime, piecesPlaced = 0, isGameOver = false;
        let isProcessingPhysics = false, inputQueue = null, dasTimer = null, dasIntervalTimer = null;
        let animationId = null, linesUntilNextLevel = 10, activeTheme = 'forest', randomThemeInterval = null, activeThemeAnimationId = null;
        
        let settings = { dasDelay: 120, dasInterval: 40, musicTrack: 'Ambient', soundSet: 'Zen', backgroundMode: 'Level', backgroundTheme: 'forest', keyBindings: { moveLeft: 'ArrowLeft', moveRight: 'ArrowRight', rotateRight: 'ArrowUp', rotateLeft: 'z', flip: 'a', softDrop: 'ArrowDown', hardDrop: 'Space', toggleMusic: 'M' } };
        const soundManager = new SoundManager();

        function createCosmicChimesScene() {
            const dustContainer = document.getElementById('space-dust');
            if (dustContainer && dustContainer.children.length === 0) {
                for (let i = 0; i < 70; i++) {
                    let particle = document.createElement('div');
                    particle.className = 'dust-particle';
                    const size = Math.random() * 2 + 1;
                    particle.style.width = `${size}px`;
                    particle.style.height = `${size}px`;
                    particle.style.setProperty('--x-start', `${Math.random() * 100}vw`);
                    particle.style.setProperty('--y-start', `${Math.random() * 100}vh`);
                    particle.style.setProperty('--x-end', `${Math.random() * 100}vw`);
                    particle.style.setProperty('--y-end', `${Math.random() * 100}vh`);
                    particle.style.animationDelay = `-${Math.random() * 30}s`;
                    dustContainer.appendChild(particle);
                }
            }
            const chimesContainer = document.getElementById('chimes');
            if (chimesContainer && chimesContainer.children.length === 0) {
                 for (let i = 0; i < 12; i++) {
                    let chime = document.createElement('div');
                    chime.className = 'chime';
                    chime.style.left = `${5 + Math.random() * 90}%`;
                    chime.style.top = `${-10 + Math.random() * 30}%`;
                    chime.style.setProperty('--r-start', `${Math.random() * 10 - 5}deg`);
                    chime.style.setProperty('--r-end', `${Math.random() * 10 - 5}deg`);
                    chime.style.animationDelay = `-${Math.random() * 12}s`;
                    chimesContainer.appendChild(chime);
                }
            }
        }
        function createSingingBowlScene() {
            const ripplesContainer = document.getElementById('bowl-ripples');
            if (ripplesContainer && ripplesContainer.children.length === 0) {
                for (let i=0; i<3; i++) {
                    let ripple = document.createElement('div');
                    ripple.className = 'bowl-ripple';
                    ripple.style.animationDelay = `${i * 2.6}s`;
                    ripplesContainer.appendChild(ripple);
                }
            }
            const motesContainer = document.getElementById('bowl-motes');
            if (motesContainer && motesContainer.children.length === 0) {
                for (let i=0; i<30; i++) {
                    let mote = document.createElement('div');
                    mote.className = 'bowl-mote';
                    const size = Math.random() * 3 + 1;
                    mote.style.width = `${size}px`;
                    mote.style.height = `${size}px`;
                    mote.style.left = `${Math.random() * 100}%`;
                    mote.style.animationDuration = `${Math.random() * 10 + 10}s`;
                    mote.style.animationDelay = `-${Math.random() * 15}s`;
                    motesContainer.appendChild(mote);
                }
            }
        }
        function createStarlightScene() {
             const layers = [
                { container: document.getElementById('starlights-back'), count: 80, minSize: 0.5, maxSize: 1.5 },
                { container: document.getElementById('starlights-mid'), count: 60, minSize: 1, maxSize: 2 },
                { container: document.getElementById('starlights-front'), count: 40, minSize: 1.5, maxSize: 2.5 }
            ];
            layers.forEach(layer => {
                if (layer.container && layer.container.children.length === 0) {
                    for (let i = 0; i < layer.count; i++) {
                        let star = document.createElement('div');
                        star.className = 'starlight';
                        const size = Math.random() * (layer.maxSize - layer.minSize) + layer.minSize;
                        star.style.width = `${size}px`;
                        star.style.height = `${size}px`;
                        star.style.left = `${Math.random() * 100}%`;
                        star.style.top = `${Math.random() * 100}%`;
                        star.style.animationDelay = `-${Math.random() * 8}s`;
                        layer.container.appendChild(star);
                    }
                }
            });
        }
        function createMeadowScene() {
            // Swaying Grass
            const grassContainer = document.querySelector('.meadow-grass');
            if (grassContainer && grassContainer.children.length === 0) {
                for (let i = 0; i < 100; i++) {
                    let blade = document.createElement('div');
                    blade.className = 'grass-blade';
                    blade.style.left = `${i}%`;
                    blade.style.height = `${Math.random() * 50 + 50}px`;
                    blade.style.animationDelay = `-${Math.random() * 5}s`;
                    blade.style.filter = `brightness(${Math.random() * 0.4 + 0.8})`;
                    grassContainer.appendChild(blade);
                }
            }
            // Pollen
            const pollenContainer = document.getElementById('meadow-pollen');
            if (pollenContainer && pollenContainer.children.length === 0) {
                for (let i = 0; i < 70; i++) {
                    let particle = document.createElement('div');
                    particle.className = 'pollen-particle';
                    particle.style.setProperty('--x-start', `${Math.random() * 100}vw`);
                    particle.style.setProperty('--y-start', `${100 + Math.random() * 30}vh`);
                    particle.style.setProperty('--x-end', `${Math.random() * 100}vw`);
                    for(let j = 1; j <= 3; j++) {
                        particle.style.setProperty(`--x-gust${j}`, `${Math.random() * 40 - 20}vw`);
                    }
                    particle.style.animationDelay = `${Math.random() * 10}s`;
                    pollenContainer.appendChild(particle);
                }
            }
            // Butterflies
            const butterflyContainer = document.getElementById('meadow-butterflies');
            if (butterflyContainer && butterflyContainer.children.length === 0) {
                for (let i = 0; i < 8; i++) {
                    let butterfly = document.createElement('div');
                    butterfly.className = 'butterfly';
                    const wingLeft = document.createElement('div');
                    wingLeft.className = 'butterfly-wing left';
                    const wingRight = document.createElement('div');
                    wingRight.className = 'butterfly-wing right';
                    butterfly.appendChild(wingLeft);
                    butterfly.appendChild(wingRight);

                    for(let j=1; j<=4; j++){
                        butterfly.style.setProperty(`--x${j}`, `${Math.random() * 90}vw`);
                        butterfly.style.setProperty(`--y${j}`, `${Math.random() * 80}vh`);
                    }
                    butterfly.style.animationDelay = `-${Math.random() * 20}s`;
                    const flapSpeed = Math.random() * 0.3 + 0.3;
                    wingLeft.style.animationDuration = `${flapSpeed}s`;
                    wingRight.style.animationDuration = `${flapSpeed}s`;

                    butterflyContainer.appendChild(butterfly);
                }
            }
        }
        function createKoiPondScene() {
            // 1. Lily Pads
            const lilyPadContainer = document.getElementById('lily-pads');
            if (lilyPadContainer && lilyPadContainer.children.length === 0) {
                const numPads = 5;
                for (let i = 0; i < numPads; i++) {
                    let pad = document.createElement('div');
                    pad.className = 'lily-pad';
                    pad.style.setProperty('--x-pos', `${10 + Math.random() * 80}vw`);
                    pad.style.setProperty('--y-pos', `${10 + Math.random() * 80}vh`);
                    pad.style.animationDelay = `-${Math.random() * 20}s`;
                    lilyPadContainer.appendChild(pad);
                }
            }

            // 2. Koi Fish & Ripples
            const koiContainer = document.getElementById('koi-fish');
            const rippleContainer = document.getElementById('koi-ripples');
            const koiInstances = [];

            if (koiContainer && koiContainer.children.length === 0) {
                const numKoi = 7;
                const koiColors = [
                    { base: '#f08c28', spots: ['#000', '#fff'] },
                    { base: '#fff', spots: ['#d44d2d', '#000'] },
                    { base: '#333', spots: ['#f08c28', '#fff'] }
                ];

                for (let i = 0; i < numKoi; i++) {
                    let koi = document.createElement('div');
                    koi.className = 'koi';

                    const colors = koiColors[Math.floor(Math.random() * koiColors.length)];
                    let spotsSvg = '';
                    for(let j=0; j<3; j++){
                        spotsSvg += `<circle cx="${Math.random()*80+10}" cy="${Math.random()*20+10}" r="${Math.random()*5+3}" fill="${colors.spots[Math.floor(Math.random()*colors.spots.length)]}" opacity="0.8"/>`;
                    }
                    const koiSvg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 40"><path d="M50 0 C20 0, 0 20, 0 20 S20 40, 50 40 C80 40, 100 20, 100 20 S80 0, 50 0 Z" fill="${colors.base}"/>${spotsSvg}</svg>`;
                    koi.style.backgroundImage = `url('data:image/svg+xml;utf8,${encodeURIComponent(koiSvg)}')`;

                    for(let j=1; j<=5; j++){
                        koi.style.setProperty(`--x${j}`, `${Math.random() * 90}vw`);
                        koi.style.setProperty(`--y${j}`, `${Math.random() * 90}vh`);
                        koi.style.setProperty(`--r${j}`, `${Math.random() * 360}deg`);
                    }
                    koi.style.animationDelay = `-${Math.random() * 25}s`;

                    koiContainer.appendChild(koi);
                    koiInstances.push(koi);
                }

                let lastRippleTime = 0;
                function rippleLoop(timestamp) {
                    if (activeTheme !== 'koi-pond') return;
                    if (timestamp - lastRippleTime > 800) {
                         lastRippleTime = timestamp;
                         koiInstances.forEach(koi => {
                            if (Math.random() > 0.6) {
                                const rect = koi.getBoundingClientRect();
                                if (rect.top > 0 && rect.left > 0) {
                                    let ripple = document.createElement('div');
                                    ripple.className = 'koi-ripple';
                                    ripple.style.left = `${rect.left + rect.width / 2}px`;
                                    ripple.style.top = `${rect.top + rect.height / 2}px`;
                                    ripple.addEventListener('animationend', () => ripple.remove(), { once: true });
                                    rippleContainer.appendChild(ripple);
                                }
                            }
                        });
                    }
                    activeThemeAnimationId = requestAnimationFrame(rippleLoop);
                }
                rippleLoop(0);
            }
        }
        function createRainyWindow() {
            const canvas = document.getElementById('rain-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            function resizeCanvas() {
                if (!canvas) return;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas, false);
            resizeCanvas();

            let drops = [];
            function createDrop(isInitial) {
                return {
                    x: Math.random() * canvas.width,
                    y: isInitial ? Math.random() * canvas.height : -50,
                    r: Math.random() * 1.5 + 1,
                    vy: Math.random() * 3 + 2,
                    isStreaking: false
                };
            }
            for(let i=0; i<150; i++){ drops.push(createDrop(true)); }

            function animate() {
                if (activeTheme !== 'rainy-window') {
                    return;
                }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if(Math.random() > 0.8) drops.push(createDrop(false));

                for (let i = drops.length - 1; i >= 0; i--) {
                    let drop = drops[i];
                    if (drop.r > 3.5) drop.isStreaking = true;
                    drop.y += drop.vy;
                    if (drop.isStreaking) {
                        ctx.beginPath();
                        ctx.moveTo(drop.x, drop.y - drop.r * 4);
                        ctx.lineTo(drop.x, drop.y);
                        ctx.strokeStyle = `rgba(220, 230, 255, 0.3)`;
                        ctx.lineWidth = drop.r * 0.6;
                        ctx.stroke();
                    }
                    ctx.beginPath();
                    ctx.arc(drop.x, drop.y, drop.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(220, 230, 255, 0.6)`;
                    ctx.fill();

                    for (let j = i - 1; j >= 0; j--) {
                        let other = drops[j];
                        let dx = drop.x - other.x;
                        let dy = drop.y - other.y;
                        if (Math.sqrt(dx*dx + dy*dy) < drop.r + other.r) {
                            drop.r = Math.min(Math.sqrt(Math.pow(drop.r, 2) + Math.pow(other.r, 2)), 15);
                            drops.splice(j, 1);
                            i--;
                            break;
                        }
                    }
                    if (drop.y > canvas.height + 50) drops.splice(i, 1);
                }
                activeThemeAnimationId = requestAnimationFrame(animate);
            }
            animate();
        }
        function resizeGame() {
            const margin = 0.95;
            const availableHeight = window.innerHeight * margin;
            const availableWidth = window.innerWidth * margin;

            // Roughly 5 rows for the 'next' pieces container and other UI elements
            let blockSizeFromHeight = availableHeight / (ROWS + 5);

            let blockSizeFromWidth;
            // Consider sidebar width in desktop mode
            if (window.innerWidth > 768) {
                const sidebarWidth = 180; // As defined in CSS for .panel
                const gap = 30; // As defined in CSS for .game-container
                blockSizeFromWidth = (availableWidth - sidebarWidth - gap) / COLS;
            } else {
                blockSizeFromWidth = availableWidth / COLS;
            }

            BLOCK_SIZE = Math.floor(Math.min(blockSizeFromHeight, blockSizeFromWidth));

            canvas.width = COLS * BLOCK_SIZE;
            canvas.height = ROWS * BLOCK_SIZE;

            // Maintain aspect ratio of next piece canvases relative to new BLOCK_SIZE
            // Original BLOCK_SIZE=30, next-0 is 60x50, others are 50x40
            if (nextCanvases && nextCanvases.length > 0) {
                nextCanvases[0].width = BLOCK_SIZE * 2;
                nextCanvases[0].height = BLOCK_SIZE * (50/30);
                for (let i = 1; i < 5; i++) {
                    nextCanvases[i].width = BLOCK_SIZE * (50/30);
                    nextCanvases[i].height = BLOCK_SIZE * (40/30);
                }
            }

            // Redraw the game with new sizes if the game is active
            if (!isGameOver && currentPiece) {
                draw();
                drawNextPieces();
            }
        }

        function init() {
            canvas = document.getElementById('game-canvas'); ctx = canvas.getContext('2d');
            nextCanvases = Array.from({length: 5}, (_, i) => document.getElementById(`next-${i}`));

            resizeGame();
            window.addEventListener('resize', resizeGame);

            createParticles(); loadSettings(); setupUI();
            document.addEventListener('click', initSound, { once: true });
            document.addEventListener('keydown', initSound, { once: true });
            document.addEventListener('fullscreenchange', () => {
                const fullscreenBtn = document.getElementById('fullscreen-toggle');
                fullscreenBtn.textContent = document.fullscreenElement ? '><' : '⛶';
            });
            resetGame();
        }
        
        function createSwedishForest() {
            // Pine tree generation for parallax layers
            const layers = [
                { el: document.getElementById('sf-layer-1'), count: 80, height: 150, color: 'rgba(20, 40, 50, 0.7)' },
                { el: document.getElementById('sf-layer-2'), count: 60, height: 250, color: 'rgba(30, 55, 70, 0.8)' },
                { el: document.getElementById('sf-layer-3'), count: 40, height: 400, color: 'rgba(40, 70, 90, 0.9)' }
            ];

            layers.forEach(layer => {
                if(layer.el && !layer.el.style.backgroundImage) {
                    const T_WIDTH = 100;
                    let canvas = document.createElement('canvas');
                    canvas.width = layer.count * T_WIDTH;
                    canvas.height = layer.height;
                    let ctx = canvas.getContext('2d');

                    for(let i = 0; i < layer.count; i++) {
                        const h = layer.height * (0.6 + Math.random() * 0.4);
                        const tH = h * (0.1 + Math.random() * 0.05);
                        const x = i * T_WIDTH + (Math.random() - 0.5) * 20;

                        // Draw trunk
                        ctx.fillStyle = layer.color;
                        ctx.fillRect(x + T_WIDTH/2 - 5, canvas.height - tH, 10, tH);

                        // Draw foliage
                        let y = canvas.height - tH;
                        let w = T_WIDTH * 0.9;
                        let numLayers = 5 + Math.floor(Math.random() * 3);
                        let layerHeight = y / numLayers;

                        for (let j = 0; j < numLayers; j++) {
                            let cY = y - (j * layerHeight);
                            let cW = w * ((numLayers - j) / numLayers) * (1 + (Math.random() - 0.5) * 0.2);
                            let sway = (Math.random() - 0.5) * 10;

                            ctx.beginPath();
                            ctx.moveTo(x + T_WIDTH/2 + sway, cY - layerHeight);
                            ctx.lineTo(x + T_WIDTH/2 - cW/2, cY);
                            ctx.lineTo(x + T_WIDTH/2 + cW/2, cY);
                            ctx.closePath();
                            ctx.fill();
                        }
                    }
                    layer.el.style.backgroundImage = `url(${canvas.toDataURL()})`;
                    layer.el.style.backgroundSize = `${canvas.width}px ${canvas.height}px`;
                }
            });

            // God ray generation
            const godRayContainer = document.querySelector('.god-ray-container');
            if (godRayContainer && godRayContainer.children.length === 0) {
                for (let i = 0; i < 15; i++) {
                    let ray = document.createElement('div');
                    ray.className = 'god-ray';
                    ray.style.left = `${Math.random() * 120 - 10}%`;
                    ray.style.top = '0px';
                    ray.style.width = `${Math.random() * 4 + 2}px`;
                    ray.style.height = '120%';
                    ray.style.transform = `rotate(${Math.random() * 20 - 10}deg)`;
                    ray.style.opacity = `${Math.random() * 0.1 + 0.05}`;
                    godRayContainer.appendChild(ray);
                }
            }
        }
        function createGalaxyScene() {
            // Background Stars
            const starsContainer = document.getElementById('galaxy-stars-bg');
            if (starsContainer && starsContainer.children.length === 0) {
                for (let i = 0; i < 200; i++) {
                    let star = document.createElement('div');
                    star.className = 'galaxy-star-bg';
                    const size = Math.random() * 2 + 0.5;
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 15}s`;
                    starsContainer.appendChild(star);
                }
            }

            // Shooting Stars
            const shootingStarContainer = document.getElementById('shooting-stars');
            if (shootingStarContainer && shootingStarContainer.children.length === 0) {
                for (let i = 0; i < 5; i++) {
                    let star = document.createElement('div');
                    star.className = 'shooting-star';
                    star.style.top = `${Math.random() * 100}%`;
                    const duration = Math.random() * 5 + 5;
                    star.style.animationDuration = `${duration}s`;
                    star.style.animationDelay = `${Math.random() * 20}s`;
                    star.style.width = `${Math.random() * 100 + 100}px`;
                    shootingStarContainer.appendChild(star);
                }
            }
        }
        function createAuroraScene() {
            // Faint, twinkling stars
            const starsContainer = document.getElementById('aurora-stars');
            if (starsContainer && starsContainer.children.length === 0) {
                for (let i = 0; i < 150; i++) {
                    let star = document.createElement('div');
                    star.className = 'aurora-star';
                    const size = Math.random() * 1.5 + 0.5;
                    star.style.width = `${size}px`;
                    star.style.height = `${size}px`;
                    star.style.left = `${Math.random() * 100}%`;
                    star.style.top = `${Math.random() * 100}%`;
                    star.style.animationDelay = `${Math.random() * 10}s`;
                    starsContainer.appendChild(star);
                }
            }
        }
        function createSpringScene() {
            // Gentle Rain
            const rainContainer = document.getElementById('spring-rain');
            if (rainContainer && rainContainer.children.length === 0) {
                for (let i = 0; i < 60; i++) {
                    let drop = document.createElement('div');
                    drop.className = 'spring-raindrop';
                    drop.style.left = `${Math.random() * 100}%`;
                    const duration = Math.random() * 0.5 + 0.5;
                    drop.style.animationDuration = `${duration}s`;
                    drop.style.animationDelay = `-${Math.random() * duration}s`;
                    rainContainer.appendChild(drop);
                }
            }

            // Unfurling Sprouts
            const sproutsContainer = document.getElementById('sprouts-container');
            if (sproutsContainer && sproutsContainer.children.length === 0) {
                for (let i = 0; i < 20; i++) {
                    let sprout = document.createElement('div');
                    sprout.className = 'sprout';
                    sprout.style.left = `${5 + Math.random() * 90}%`;
                    sprout.style.animationDelay = `${Math.random() * 15}s`;

                    const leftLeaf = document.createElement('div');
                    leftLeaf.className = 'left';
                    const rightLeaf = document.createElement('div');
                    rightLeaf.className = 'right';

                    sprout.appendChild(leftLeaf);
                    sprout.appendChild(rightLeaf);
                    sproutsContainer.appendChild(sprout);
                }
            }
        }
        function createRainyWindow() {
            const canvas = document.getElementById('rain-canvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');

            function resizeCanvas() {
                if (!canvas) return;
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener('resize', resizeCanvas, false);
            resizeCanvas();

            let drops = [];
            function createDrop(isInitial) {
                return {
                    x: Math.random() * canvas.width,
                    y: isInitial ? Math.random() * canvas.height : -50,
                    r: Math.random() * 1.5 + 1,
                    vy: Math.random() * 3 + 2,
                    isStreaking: false
                };
            }
            for(let i=0; i<150; i++){ drops.push(createDrop(true)); }

            function animate() {
                if (activeTheme !== 'rainy-window') {
                    return;
                }
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                if(Math.random() > 0.8) drops.push(createDrop(false));

                for (let i = drops.length - 1; i >= 0; i--) {
                    let drop = drops[i];
                    if (drop.r > 3.5) drop.isStreaking = true;
                    drop.y += drop.vy;
                    if (drop.isStreaking) {
                        ctx.beginPath();
                        ctx.moveTo(drop.x, drop.y - drop.r * 4);
                        ctx.lineTo(drop.x, drop.y);
                        ctx.strokeStyle = `rgba(220, 230, 255, 0.3)`;
                        ctx.lineWidth = drop.r * 0.6;
                        ctx.stroke();
                    }
                    ctx.beginPath();
                    ctx.arc(drop.x, drop.y, drop.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(220, 230, 255, 0.6)`;
                    ctx.fill();

                    for (let j = i - 1; j >= 0; j--) {
                        let other = drops[j];
                        let dx = drop.x - other.x;
                        let dy = drop.y - other.y;
                        if (Math.sqrt(dx*dx + dy*dy) < drop.r + other.r) {
                            drop.r = Math.min(Math.sqrt(Math.pow(drop.r, 2) + Math.pow(other.r, 2)), 15);
                            drops.splice(j, 1);
                            i--;
                            break;
                        }
                    }
                    if (drop.y > canvas.height + 50) drops.splice(i, 1);
                }
                activeThemeAnimationId = requestAnimationFrame(animate);
            }
            animate();
        }
        function createSummerScene() {
            // God Rays
            const godRayContainer = document.querySelector('.god-rays-summer');
            if (godRayContainer && godRayContainer.children.length === 0) {
                for (let i = 0; i < 15; i++) {
                    let ray = document.createElement('div');
                    ray.className = 'summer-god-ray';
                    ray.style.left = `${Math.random() * 140 - 20}%`;
                    ray.style.top = '0px';
                    ray.style.width = `${Math.random() * 5 + 2}px`;
                    ray.style.height = '120%';
                    ray.style.transform = `rotate(${Math.random() * 40 - 20}deg)`;
                    ray.style.opacity = `${Math.random() * 0.1 + 0.1}`;
                    godRayContainer.appendChild(ray);
                }
            }

            // Dandelion Seeds
            const seedContainer = document.getElementById('dandelion-seeds');
            if (seedContainer && seedContainer.children.length === 0) {
                for (let i = 0; i < 40; i++) {
                    let seed = document.createElement('div');
                    seed.className = 'dandelion-seed';
                    seed.style.setProperty('--x-start', `${Math.random() * 100}vw`);
                    seed.style.setProperty('--y-start', `${100 + Math.random() * 20}vh`);
                    seed.style.setProperty('--x-end', `${Math.random() * 100}vw`);
                    seed.style.setProperty('--y-end', `${-20 + Math.random() * -20}vh`);
                    seed.style.animationDuration = `${Math.random() * 10 + 15}s`;
                    seed.style.animationDelay = `${Math.random() * 20}s`;
                    seedContainer.appendChild(seed);
                }
            }
        }
        function createAutumnScene() {
            // Define leaf shapes and colors
            const leafShapes = [
                'M15 0 C0 5, 5 25, 15 30 C25 25, 30 5, 15 0 Z', // Simple teardrop
                'M15 0 L17 10 L30 12 L18 18 L22 30 L15 25 L8 30 L12 18 L0 12 L13 10 Z', // Maple-like
                'M15 0 C 0 10, 0 20, 5 30 C 10 25, 20 25, 25 30 C 30 20, 30 10, 15 0 Z' // Oak-like
            ];
            const leafColors = ['#d44d2d', '#f7a156', '#a26e49', '#6d4c3c'];

            // Multi-layered falling leaves
            const leafLayers = [
                { container: document.getElementById('fall-leaves-back'), count: 20, minSize: 15, maxSize: 25, minDuration: 15, maxDuration: 20 },
                { container: document.getElementById('fall-leaves-mid'), count: 15, minSize: 20, maxSize: 35, minDuration: 10, maxDuration: 15 },
                { container: document.getElementById('fall-leaves-front'), count: 10, minSize: 25, maxSize: 45, minDuration: 7, maxDuration: 12 }
            ];

            leafLayers.forEach(layer => {
                if (layer.container && layer.container.children.length === 0) {
                    for (let i = 0; i < layer.count; i++) {
                        let leaf = document.createElement('div');
                        leaf.className = 'leaf';
                        const shape = leafShapes[Math.floor(Math.random() * leafShapes.length)];
                        const color = leafColors[Math.floor(Math.random() * leafColors.length)];
                        leaf.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"><path d="${shape}" fill="${encodeURIComponent(color)}"/></svg>')`;
                        const size = Math.random() * (layer.maxSize - layer.minSize) + layer.minSize;
                        leaf.style.width = `${size}px`;
                        leaf.style.height = `${size}px`;

                        leaf.style.setProperty('--x-start', `${Math.random() * 100}vw`);
                        leaf.style.setProperty('--x-end', `${Math.random() * 100}vw`);
                        leaf.style.setProperty('--r-start', `${Math.random() * 360}deg`);
                        leaf.style.setProperty('--r-end', `${Math.random() * 1440 - 720}deg`);
                        for(let j = 1; j <= 4; j++) {
                            leaf.style.setProperty(`--x-gust${j}`, `${Math.random() * 20 - 10}vw`);
                        }

                        const duration = Math.random() * (layer.maxDuration - layer.minDuration) + layer.minDuration;
                        leaf.style.animationDuration = `${duration}s`;
                        leaf.style.animationDelay = `-${Math.random() * duration}s`;
                        layer.container.appendChild(leaf);
                    }
                }
            });

            // Ground leaves
            const groundContainer = document.querySelector('.ground-leaves');
            if (groundContainer && !groundContainer.style.backgroundImage) {
                let canvas = document.createElement('canvas');
                canvas.width = 400; canvas.height = 50;
                let ctx = canvas.getContext('2d');
                for(let i=0; i < 80; i++) {
                    const shape = leafShapes[Math.floor(Math.random() * leafShapes.length)];
                    const color = leafColors[Math.floor(Math.random() * leafColors.length)];
                    const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 30 30"><path d="${shape}" fill="${color}"/></svg>`;
                    const img = new Image();
                    img.onload = () => {
                        ctx.save();
                        ctx.translate(Math.random() * canvas.width, Math.random() * canvas.height);
                        ctx.rotate((Math.random() - 0.5) * Math.PI);
                        const size = Math.random() * 20 + 15;
                        ctx.globalAlpha = Math.random() * 0.5 + 0.5;
                        ctx.drawImage(img, -size/2, -size/2, size, size);
                        ctx.restore();
                        groundContainer.style.backgroundImage = `url(${canvas.toDataURL()})`;
                    };
                    img.src = `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
                }
            }
        }
        function createWinterScene() {
            // Multi-layered snowfall
            const snowflakeLayers = [
                { container: document.getElementById('snowflakes-back'), count: 50, minSize: 0.5, maxSize: 1.5, minDuration: 20, maxDuration: 30 },
                { container: document.getElementById('snowflakes-mid'), count: 40, minSize: 1, maxSize: 2.5, minDuration: 10, maxDuration: 15 },
                { container: document.getElementById('snowflakes-front'), count: 30, minSize: 2, maxSize: 4, minDuration: 5, maxDuration: 8 }
            ];

            snowflakeLayers.forEach(layer => {
                if (layer.container && layer.container.children.length === 0) {
                    for (let i = 0; i < layer.count; i++) {
                        let flake = document.createElement('div');
                        flake.className = 'snowflake';
                        flake.textContent = '•';
                        const size = Math.random() * (layer.maxSize - layer.minSize) + layer.minSize;
                        flake.style.fontSize = `${size}rem`;
                        const xStart = Math.random() * 120 - 10;
                        flake.style.setProperty('--x-start', `${xStart}vw`);
                        flake.style.setProperty('--x-end', `${xStart + (Math.random() * 20 - 10)}vw`);
                        flake.style.setProperty('--r-end', `${Math.random() * 720 - 360}deg`);
                        const duration = Math.random() * (layer.maxDuration - layer.minDuration) + layer.minDuration;
                        flake.style.animationDuration = `${duration}s`;
                        flake.style.animationDelay = `-${Math.random() * duration}s`;
                        layer.container.appendChild(flake);
                    }
                }
            });

            // Ice crystal generation
            const crystalContainer = document.querySelector('.ice-crystals');
            if (crystalContainer && crystalContainer.children.length === 0) {
                for (let i = 0; i < 25; i++) {
                    let crystal = document.createElement('div');
                    crystal.className = 'ice-crystal';

                    if (Math.random() > 0.5) {
                        crystal.style.left = `${Math.random() * 100}%`;
                        crystal.style.top = Math.random() > 0.5 ? `${Math.random() * 15}%` : `${85 + Math.random() * 15}%`;
                    } else {
                        crystal.style.top = `${Math.random() * 100}%`;
                        crystal.style.left = Math.random() > 0.5 ? `${Math.random() * 15}%` : `${85 + Math.random() * 15}%`;
                    }
                    const size = Math.random() * 100 + 50;
                    crystal.style.width = `${size}px`;
                    crystal.style.height = `${size}px`;
                    crystal.style.animationDelay = `${Math.random() * 40}s`;
                    crystalContainer.appendChild(crystal);
                }
            }
        }
        function createEnchantedForest() {
            // Tree generation for parallax layers
            const layers = [
                { el: document.getElementById('enchanted-forest-back'), count: 40, color: 'rgba(10, 15, 25, 0.7)', height: 250 },
                { el: document.getElementById('enchanted-forest-mid'), count: 30, color: 'rgba(20, 30, 50, 0.8)', height: 350 },
                { el: document.getElementById('enchanted-forest-front'), count: 20, color: 'rgba(30, 45, 75, 0.9)', height: 500 }
            ];

            layers.forEach(layer => {
                if(layer.el && !layer.el.style.backgroundImage) {
                    const T_WIDTH = 150;
                    let canvas = document.createElement('canvas');
                    canvas.width = layer.count * T_WIDTH;
                    canvas.height = layer.height;
                    let ctx = canvas.getContext('2d');
                    ctx.fillStyle = layer.color;
                    ctx.strokeStyle = layer.color;

                    for(let i = 0; i < layer.count; i++) {
                        const x = i * T_WIDTH + Math.random() * (T_WIDTH / 2);
                        const h = layer.height * (0.7 + Math.random() * 0.3);
                        const trunkWidth = 10 + Math.random() * 10;

                        // Draw trunk
                        ctx.beginPath();
                        ctx.moveTo(x, canvas.height);
                        ctx.lineTo(x + trunkWidth / 4, canvas.height - h / 2);
                        ctx.lineTo(x - trunkWidth / 4, canvas.height - h);
                        ctx.lineWidth = trunkWidth;
                        ctx.stroke();

                        // Draw branches
                        for(let j = 0; j < 5; j++) {
                            const branchY = canvas.height - h + (Math.random() * (h/2));
                            const branchLen = Math.random() * 40 + 20;
                            const angle = (Math.random() - 0.5) * Math.PI;
                            ctx.beginPath();
                            ctx.moveTo(x - trunkWidth / 4, branchY);
                            ctx.lineTo(x - trunkWidth / 4 + Math.cos(angle) * branchLen, branchY + Math.sin(angle) * branchLen);
                            ctx.lineWidth = Math.random() * 3 + 1;
                            ctx.stroke();
                        }
                    }
                    layer.el.style.backgroundImage = `url(${canvas.toDataURL()})`;
                    layer.el.style.backgroundSize = `${canvas.width}px ${canvas.height}px`;
                }
            });
        }
        function createSunset() {
            // Volumetric Clouds
            const cloudLayers = [
                { el: document.getElementById('sunset-clouds-back'), count: 20, color1: 'rgba(255, 255, 255, 0.1)', color2: 'rgba(230, 200, 200, 0.1)', height: 300},
                { el: document.getElementById('sunset-clouds-mid'), count: 15, color1: 'rgba(255, 240, 220, 0.3)', color2: 'rgba(255, 210, 180, 0.4)', height: 250},
                { el: document.getElementById('sunset-clouds-front'), count: 10, color1: 'rgba(255, 255, 240, 0.6)', color2: 'rgba(255, 220, 200, 0.7)', height: 200}
            ];

            cloudLayers.forEach(layer => {
                if (layer.el && !layer.el.style.backgroundImage) {
                    const C_WIDTH = 400;
                    let canvas = document.createElement('canvas');
                    canvas.width = layer.count * C_WIDTH;
                    canvas.height = layer.height;
                    let ctx = canvas.getContext('2d');

                    for (let i = 0; i < layer.count; i++) {
                        const x = i * C_WIDTH + Math.random() * (C_WIDTH / 2);
                        const y = Math.random() * (canvas.height / 2);
                        const radiusX = (Math.random() * 0.4 + 0.8) * C_WIDTH / 2;
                        const radiusY = (Math.random() * 0.3 + 0.3) * layer.height;

                        const gradient = ctx.createRadialGradient(x, y, 0, x, y, Math.max(radiusX, radiusY));
                        gradient.addColorStop(0, layer.color2);
                        gradient.addColorStop(1, layer.color1);

                        ctx.fillStyle = gradient;
                        ctx.beginPath();
                        ctx.ellipse(x, y, radiusX, radiusY, 0, 0, 2 * Math.PI);
                        ctx.fill();
                    }
                    layer.el.style.backgroundImage = `url(${canvas.toDataURL()})`;
                    layer.el.style.backgroundSize = `${canvas.width}px 100%`;
                    layer.el.style.top = `${Math.random() * 30}%`;
                }
            });

            // Dust Motes
            const dustContainer = document.getElementById('dust-motes');
            if (dustContainer && dustContainer.children.length === 0) {
                for (let i = 0; i < 50; i++) {
                    let mote = document.createElement('div');
                    mote.className = 'dust-mote';
                    const size = Math.random() * 2 + 1;
                    mote.style.width = `${size}px`;
                    mote.style.height = `${size}px`;
                    mote.style.setProperty('--x-start', `${Math.random() * 100}vw`);
                    mote.style.setProperty('--y-start', `${Math.random() * 100}vh`);
                    mote.style.setProperty('--x-end', `${Math.random() * 100}vw`);
                    mote.style.setProperty('--y-end', `${Math.random() * 100}vh`);
                    mote.style.animationDelay = `${Math.random() * 15}s`;
                    dustContainer.appendChild(mote);
                }
            }
        }
        function createDeepOcean() {
            // Caustics
            const causticsContainer = document.querySelector('#ocean-theme .caustics-container');
            if (causticsContainer && causticsContainer.children.length === 0) {
                const light = document.createElement('div');
                light.className = 'caustic-light';
                causticsContainer.appendChild(light);
            }

            // Sea Creature
            const creatureContainer = document.querySelector('#ocean-theme .sea-creature-container');
            if (creatureContainer && creatureContainer.children.length === 0) {
                const creature = document.createElement('div');
                creature.className = 'sea-creature';
                creature.style.animationDelay = `${Math.random() * 100}s`;
                creatureContainer.appendChild(creature);
            }

            // Ocean floor layers
            const layers = [
                { el: document.getElementById('ocean-floor-bg'), count: 60, color: 'rgba(5, 30, 50, 0.6)', height: 100 },
                { el: document.getElementById('ocean-floor-mid'), count: 40, color: 'rgba(10, 40, 65, 0.8)', height: 150 },
                { el: document.getElementById('ocean-floor-fg'), count: 20, color: 'rgba(15, 50, 80, 1.0)', height: 200 }
            ];

            layers.forEach(layer => {
                if (layer.el && !layer.el.style.backgroundImage) {
                    const C_WIDTH = 200;
                    let canvas = document.createElement('canvas');
                    canvas.width = layer.count * C_WIDTH;
                    canvas.height = layer.height;
                    let ctx = canvas.getContext('2d');
                    ctx.strokeStyle = layer.color;
                    ctx.fillStyle = layer.color;

                    // Draw ground
                    ctx.beginPath();
                    ctx.moveTo(0, canvas.height);
                    for (let i = 0; i < canvas.width; i++) {
                        ctx.lineTo(i, canvas.height * (0.8 + Math.sin(i * 0.01) * 0.1));
                    }
                    ctx.lineTo(canvas.width, canvas.height);
                    ctx.closePath();
                    ctx.fill();

                    // Draw seaweed & coral
                    for (let i = 0; i < layer.count; i++) {
                        const x = i * C_WIDTH + Math.random() * C_WIDTH;
                        const y = canvas.height * (0.8 + Math.sin(x * 0.01) * 0.1);

                        if (Math.random() > 0.3) { // Seaweed
                            const h = (Math.random() * 0.5 + 0.3) * layer.height;
                            ctx.beginPath();
                            ctx.moveTo(x, y);
                            ctx.bezierCurveTo(x + (Math.random()-0.5)*20, y - h*0.5, x + (Math.random()-0.5)*20, y - h*0.5, x + (Math.random()-0.5)*10, y-h);
                            ctx.lineWidth = Math.random() * 2 + 2;
                            ctx.stroke();
                        } else { // Coral
                            const h = (Math.random() * 0.2 + 0.1) * layer.height;
                            const w = (Math.random() * 0.3 + 0.2) * C_WIDTH;
                            ctx.beginPath();
                            ctx.moveTo(x,y);
                            ctx.bezierCurveTo(x - w/2, y-h/2, x - w/4, y-h, x, y-h);
                            ctx.bezierCurveTo(x + w/4, y-h, x + w/2, y-h/2, x, y);
                            ctx.fill();
                        }
                    }
                    layer.el.style.backgroundImage = `url(${canvas.toDataURL()})`;
                    layer.el.style.backgroundSize = `${canvas.width}px ${canvas.height}px`;
                }
            });
        }
        function createParticles() {
            const containers = {
                stars: { count: 100, el: 'stars' }, fireflies: { count: 20, el: 'fireflies' },
                bubbles: { count: 30, el: 'bubbles' }, clouds: { count: 5, el: 'clouds' },
                petals: { count: 25, el: 'petals' },
                forestSpirits: { count: 10, el: 'forest-spirits' }
            };

            for (const key in containers) {
                const container = document.getElementById(containers[key].el);
                if (container && container.children.length === 0) {
                    for (let i = 0; i < containers[key].count; i++) {
                        let el = document.createElement('div');
                        switch(key) {
                            case 'stars': el.className = 'star'; el.style.width = `${Math.random()*2+1}px`; el.style.height=el.style.width; el.style.left = `${Math.random()*100}%`; el.style.top = `${Math.random()*100}%`; el.style.animationDelay = `${Math.random()*5}s`; break;
                            case 'fireflies': el.className = 'firefly'; el.style.setProperty('--x-start', `${Math.random() * 100}vw`); el.style.setProperty('--y-start', `${Math.random() * 100}vh`); el.style.setProperty('--x-end', `${Math.random() * 100}vw`); el.style.setProperty('--y-end', `${Math.random() * 100}vh`); el.style.animationDelay = `${Math.random() * 15}s`; break;
                            case 'bubbles': el.className = 'bubble'; const size = Math.random()*15+5; el.style.width=`${size}px`; el.style.height=`${size}px`; el.style.left=`${Math.random()*100}%`; el.style.animationDuration=`${Math.random()*10+10}s`; el.style.animationDelay=`${Math.random()*15}s`; el.style.setProperty('--x-drift', `${Math.random()*4-2}vw`); el.style.setProperty('--x-drift-end', `${Math.random()*4-2}vw`); break;
                            case 'clouds': el.className='cloud'; el.style.top=`${Math.random()*40+5}%`; el.style.transform=`scale(${Math.random()*0.5+0.5})`; el.style.animationDuration=`${Math.random()*40+30}s`; el.style.animationDelay=`${Math.random()*30}s`; break;
                            case 'petals': el.className='petal'; el.style.left=`${Math.random()*100}%`; el.style.setProperty('--r-start', `${Math.random()*360}deg`); el.style.setProperty('--r-end', `${Math.random()*720-360}deg`); el.style.setProperty('--x-drift', `${Math.random()*40-20}vw`); el.style.animationDelay = `${Math.random()*12}s`; break;
                            case 'snowflakes': el.className = 'snowflake'; el.textContent = '❄'; const snowSize = Math.random() * 0.8 + 0.4; el.style.fontSize = `${snowSize}rem`; el.style.left = `${Math.random()*100}%`; el.style.animationDuration=`${Math.random()*10+8}s`; el.style.animationDelay=`${Math.random()*10}s`; el.style.setProperty('--x-drift', `${Math.random()*6-3}vw`); el.style.setProperty('--r-end', `${Math.random()*360-180}deg`); break;
                            case 'leaves': el.className = 'leaf'; const leafColor = ['#c84c0f', '#e67e22', '#f1c40f'][Math.floor(Math.random() * 3)]; el.style.backgroundImage = `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M10 0 C0 5, 5 15, 10 20 C15 15, 20 5, 10 0 Z" fill="${encodeURIComponent(leafColor)}"/></svg>')`; el.style.left=`${Math.random()*100}%`; el.style.animationDuration=`${Math.random()*8+7}s`; el.style.animationDelay=`${Math.random()*10}s`; el.style.setProperty('--x-drift', `${Math.random()*20-10}vw`); el.style.setProperty('--r-end', `${Math.random()*1080-540}deg`); break;
                            case 'sunRays': el.className = 'sun-ray'; el.style.height = `${Math.random()*400+300}px`; el.style.width = `${Math.random()*30+20}px`; el.style.top = '0'; el.style.left = `${Math.random()*100-25}%`; el.style.setProperty('--r-start', `${Math.random()*10-5}deg`); el.style.setProperty('--r-end', `${Math.random()*10-5}deg`); el.style.animationDelay = `${Math.random()*5}s`; break;
                            case 'sparkles': el.className = 'sparkle'; el.style.left = `${Math.random()*100}%`; el.style.top = `${Math.random()*100}%`; el.style.animationDelay = `${Math.random()*2}s`; break;
                            case 'sprouts': el.className = 'sprout'; el.style.left = `${Math.random()*100}%`; el.style.bottom = `${Math.random()* -20}px`; el.style.animationDuration = `${Math.random()*8+6}s`; el.style.animationDelay = `${Math.random()*14}s`; el.style.setProperty('--r-end', `${Math.random()*180-90}deg`); break;
                            case 'raindrops': el.className = 'raindrop'; el.style.left = `${Math.random()*100}%`; el.style.height = `${Math.random()*50+50}px`; el.style.width = `${Math.random() * 1.5 + 1}px`; el.style.animationDuration = `${Math.random()*0.5+0.3}s`; el.style.animationDelay = `${Math.random()*5}s`; el.style.setProperty('--x-drift-rain', `${Math.random() * 10 - 5}vw`); break;
                            case 'koi': el.className = 'koi'; ['--x1','--y1','--x2','--y2','--x3','--y3','--x4','--y4', '--x5', '--y5', '--x6', '--y6', '--x7', '--y7', '--x8', '--y8'].forEach(v => el.style.setProperty(v, `${Math.random()*80+10}vw`)); ['--r1','--r2','--r3','--r4', '--r5', '--r6', '--r7', '--r8'].forEach(v => el.style.setProperty(v, `${Math.random()*360}deg`)); el.style.animationDelay = `${Math.random()*35}s`; break;
                            case 'pollen': el.className = 'pollen'; el.style.left = `${Math.random()*100}%`; el.style.top = `${Math.random()*100}%`; el.style.setProperty('--x', `${Math.random()*100-50}px`); el.style.setProperty('--y', `${Math.random()*100-50}px`); el.style.animationDelay = `${Math.random()*8}s`; break;
                            case 'butterflies': el.className = 'butterfly'; ['--x1','--y1','--x2','--y2','--x3','--y3','--x4','--y4', '--x5', '--y5', '--x6', '--y6', '--x7', '--y7', '--x8', '--y8'].forEach(v => el.style.setProperty(v, `${Math.random()*80+10}vw`)); el.style.animationDelay = `${Math.random()*15}s`; break;
                            case 'galaxyStars': el.className = 'galaxy-star'; el.style.width = `${Math.random()*2+1}px`; el.style.height=el.style.width; el.style.left = `${Math.random()*100}%`; el.style.top = `${Math.random()*100}%`; el.style.animationDelay = `${Math.random()*8}s`; break;
                            case 'chimes': el.className = 'chime'; el.style.left = `${Math.random() * 95}%`; el.style.top = `${Math.random() * 30 + 35}%`; el.style.transform = `rotate(${Math.random() * 20 - 10}deg) scaleY(${Math.random() * 0.3 + 0.8})`; el.style.animationDelay = `${Math.random() * 10}s`; break;
                            case 'ripples': el.className = 'ripple'; el.style.left = '50%'; el.style.top = '50%'; el.style.transform = 'translate(-50%, -50%)'; el.style.animationDelay = `${i * 1.6}s`; break;
                            case 'starlights': el.className = 'starlight'; const starlightSize = Math.random() * 2.5 + 1; el.style.width = `${starlightSize}px`; el.style.height = `${starlightSize}px`; el.style.left = `${Math.random() * 100}%`; el.style.top = `${Math.random() * 100}%`; el.style.animationDelay = `${Math.random() * 6}s`; break;
                            case 'forestSpirits': el.className = 'forest-spirit'; el.style.setProperty('--x-start', `${Math.random() * 80 + 10}vw`); el.style.setProperty('--y-start', `${Math.random() * 30 + 60}vh`); el.style.setProperty('--x-end', `${Math.random() * 80 + 10}vw`); el.style.setProperty('--y-end', `${Math.random() * 30 + 30}vh`); el.style.animationDelay = `${Math.random() * 25}s`; break;
                        }
                        container.appendChild(el);
                    }
                }
            }
        }
        
        function setBackground(themeName) {
            if (activeThemeAnimationId) {
                cancelAnimationFrame(activeThemeAnimationId);
                activeThemeAnimationId = null;
            }
            if (!THEMES.includes(themeName) || activeTheme === themeName) return;
            activeTheme = themeName;
            document.querySelectorAll('.theme-container').forEach(el => {
                if (el.id === `${themeName}-theme`) {
                    el.classList.add('active');
                    if (themeName === 'swedish-forest') {
                        createSwedishForest();
                    }
                    if (themeName === 'ocean') {
                        createDeepOcean();
                    }
                    if (themeName === 'sunset') {
                        createSunset();
                    }
                    if (themeName === 'forest') {
                        createEnchantedForest();
                    }
                    if (themeName === 'winter') {
                        createWinterScene();
                    }
                    if (themeName === 'fall') {
                        createAutumnScene();
                    }
                    if (themeName === 'summer') {
                        createSummerScene();
                    }
                    if (themeName === 'spring') {
                        createSpringScene();
                    }
                    if (themeName === 'aurora') {
                        createAuroraScene();
                    }
                    if (themeName === 'galaxy') {
                        createGalaxyScene();
                    }
                    if (themeName === 'rainy-window') {
                        createRainyWindow();
                    }
                    if (themeName === 'koi-pond') {
                        createKoiPondScene();
                    }
                    if (themeName === 'meadow') {
                        createMeadowScene();
                    }
                    if (themeName === 'cosmic-chimes') {
                        createCosmicChimesScene();
                    }
                    if (themeName === 'singing-bowl') {
                        createSingingBowlScene();
                    }
                    if (themeName === 'starlight') {
                        createStarlightScene();
                    }
                } else {
                    el.classList.remove('active');
                }
            });
        }

        function startRandomThemeChanger() {
            stopRandomThemeChanger();
            if (settings.backgroundMode !== 'Random' || isGameOver) return;
            randomThemeInterval = setInterval(() => {
                let newTheme;
                do { newTheme = THEMES[Math.floor(Math.random() * THEMES.length)]; } while (newTheme === activeTheme);
                setBackground(newTheme);
            }, 30000); 
        }

        function stopRandomThemeChanger() {
            if (randomThemeInterval) clearInterval(randomThemeInterval);
            randomThemeInterval = null;
        }

        function updateBackground(level) {
            if (settings.backgroundMode !== 'Level') return;
            const themeIndex = Math.floor((level - 1) / 2) % THEMES.length;
            setBackground(THEMES[themeIndex]);
        }

        function initSound() { soundManager.init(); soundManager.startBackgroundMusic(); }
        
        function resetGame() {
            lockedPieces = []; currentPiece = null; nextPieces = [];
            score = 0; lines = 0; level = 1; linesUntilNextLevel = 10;
            dropInterval = LEVEL_SPEEDS[0]; dropCounter = 0; piecesPlaced = 0;
            isGameOver = false; isProcessingPhysics = false; inputQueue = null;
            startTime = Date.now(); fillBag(); updateStats(); spawnPiece();
            stopRandomThemeChanger();
            if (settings.backgroundMode === 'Specific') {
                setBackground(settings.backgroundTheme);
            } else {
                setBackground('forest');
            }
        }
        function fillBag() { while(nextPieces.length<10) { const bag=[...PIECE_KEYS].sort(()=>Math.random()-0.5); nextPieces.push(...bag); } }
        function spawnPiece() {
            const shapeKey = nextPieces.shift();
            currentPiece = { shapeKey, shape: SHAPES[shapeKey], x: ~~(COLS/2)-~~(SHAPES[shapeKey][0].length/2), y: 0, color: COLORS[shapeKey] };
            fillBag(); drawNextPieces(); piecesPlaced++;
            if (inputQueue) { const a=inputQueue; inputQueue=null; setTimeout(() => { if (a.type==='move') move(a.dir); else if (a.type==='rotate') rotate(a.dir); }, 0); }
            if (!isValidPosition(currentPiece)) gameOver();
        }
        function generateBoard(pieces) {
            const b = Array.from({length:ROWS+HIDDEN_ROWS},()=>Array(COLS).fill(0));
            for (const p of pieces) { p.shape.forEach((r,y)=>r.forEach((v,x) => { if(v>0){ const bx=p.x+x, by=p.y+y; if(by>=0&&by<b.length&&bx>=0&&bx<COLS) b[by][bx]=p.shapeKey; } })); } return b;
        }
        function isValidPosition(p, cX=p.x, cY=p.y) {
            const boardData = generateBoard(lockedPieces);
            for (let y=0; y<p.shape.length; y++) for (let x=0; x<p.shape[y].length; x++) if (p.shape[y][x]>0) { const bx=cX+x, by=cY+y; if (bx<0||bx>=COLS||by>=boardData.length||(boardData[by]&&boardData[by][bx]!==0)) return false; } return true;
        }
        function move(dir) { if(!currentPiece||isProcessingPhysics) return; if(isValidPosition(currentPiece, currentPiece.x+dir, currentPiece.y)) { currentPiece.x+=dir; soundManager.playMove(); } }
        function rotate(dir='right') {
            if (!currentPiece||isProcessingPhysics) return; const o=currentPiece.shape;
            let r; if (dir==='right') r=o[0].map((_,i)=>o.map(row=>row[i]).reverse()); else if(dir==='left') r=o[0].map((_,i)=>o.map(row=>row[i])).reverse(); else r=o.map(row=>row.slice().reverse()).reverse();
            currentPiece.shape=r; for(const k of [0,1,-1,2,-2]) { if(isValidPosition(currentPiece, currentPiece.x+k, currentPiece.y)) { currentPiece.x+=k; soundManager.playRotate(); return; } } currentPiece.shape=o;
        }
        function softDrop() { if(!currentPiece||isProcessingPhysics) return; if(isValidPosition(currentPiece, currentPiece.x, currentPiece.y+1)) { currentPiece.y++; score+=level; dropCounter=0; } else lockPiece(); }
        function hardDrop() { if(!currentPiece||isProcessingPhysics) return; let d=0; while(isValidPosition(currentPiece,currentPiece.x,currentPiece.y+1)){currentPiece.y++;d++;} score+=d*2*level; lockPiece(); }
        function lockPiece() { if(!currentPiece) return; soundManager.playDrop(); lockedPieces.push({...currentPiece, shape:[...currentPiece.shape]}); currentPiece=null; dropCounter=0; processPhysics(); }
        async function processPhysics() {
            isProcessingPhysics=true; let loopActive=true;
            while(loopActive) {
                loopActive = false; const boardData = generateBoard(lockedPieces); const fullLines = [];
                for(let y=boardData.length-1;y>=0;y--) if(boardData[y].every(c=>c!==0)) fullLines.push(y);
                if(fullLines.length>0) {
                    loopActive=true; const oldLevel=level; lines+=fullLines.length; linesUntilNextLevel-=fullLines.length;
                    if(linesUntilNextLevel<=0){ level++; linesUntilNextLevel=10+linesUntilNextLevel; dropInterval=LEVEL_SPEEDS[Math.min(level-1, LEVEL_SPEEDS.length-1)]; soundManager.playLevelUp(); showLevelUpNotification(level); }
                    if(oldLevel!==level) updateBackground(level);
                    score+=(SCORE_VALUES[fullLines.length]||SCORE_VALUES[4])*level; soundManager.playLineClear(); showScorePopup((SCORE_VALUES[fullLines.length]||SCORE_VALUES[4])*level);
                    canvas.classList.add('line-flash'); setTimeout(()=>canvas.classList.remove('line-flash'),500);
                    fullLines.forEach(y=>{ for(let x=0;x<COLS;x++)boardData[y][x]='C'; }); board=boardData; draw(); await sleep(200);
                    let newBoard=boardData.filter((_,y)=>!fullLines.includes(y)); while(newBoard.length<ROWS+HIDDEN_ROWS)newBoard.unshift(Array(COLS).fill(0));
                    lockedPieces=findConnectedComponents(newBoard); continue;
                }
                let pieceFell = false;
                for(const p of [...lockedPieces].sort((a,b)=>b.y-a.y)) {
                    const others=lockedPieces.filter(op=>op!==p);
                    while(canFall(p, others)) { p.y++; pieceFell=true; draw(); await sleep(40); }
                }
                if(pieceFell) loopActive=true;
            }
            isProcessingPhysics=false; updateStats(); spawnPiece();
        }
        function canFall(p, others) {
            const boardData=generateBoard(others);
            for(let y=0;y<p.shape.length;y++) for(let x=0;x<p.shape[y].length;x++) if(p.shape[y][x]>0) { const by=p.y+y+1, bx=p.x+x; if(by>=boardData.length||boardData[by][bx]!==0)return false;} return true;
        }
        function findConnectedComponents(boardData) {
            const pieces=[], visited=Array.from({length:boardData.length},()=>Array(boardData[0].length).fill(false));
            for(let r=0;r<boardData.length;r++) for(let c=0;c<boardData[0].length;c++) {
                if(boardData[r][c]!==0&&!visited[r][c]) {
                    const shapeKey=boardData[r][c], component=[], queue=[[r,c]]; visited[r][c]=true;
                    let minR=r,maxR=r,minC=c,maxC=c;
                    while(queue.length>0) {
                        const [row,col]=queue.shift(); component.push({r:row,c:col});
                        minR=Math.min(minR,row); maxR=Math.max(maxR,row); minC=Math.min(minC,col); maxC=Math.max(maxC,col);
                        [[-1,0],[1,0],[0,-1],[0,1]].forEach(([dr,dc])=>{ const nr=row+dr,nc=col+dc; if(nr>=0&&nr<boardData.length&&nc>=0&&nc<boardData[0].length&&!visited[nr][nc]&&boardData[nr][nc]===shapeKey){visited[nr][nc]=true;queue.push([nr,nc]);}});
                    }
                    const shape=Array.from({length:maxR-minR+1},()=>Array(maxC-minC+1).fill(0));
                    component.forEach(({r,c})=>{shape[r-minR][c-minC]=1});
                    pieces.push({x:minC, y:minR, shape, shapeKey, color:COLORS[shapeKey]});
                }
            }
            return pieces;
        }
        function draw() {
            if (level>=10) { canvas.style.borderColor = '#ef4444'; canvas.style.boxShadow = '0 0 30px rgba(239, 68, 68, 0.6), 0 0 60px rgba(239, 68, 68, 0.4)';}
            else if (level>=5) { canvas.style.borderColor = '#fbbf24'; canvas.style.boxShadow = '0 0 30px rgba(251, 191, 36, 0.6), 0 0 60px rgba(251, 191, 36, 0.4)';}
            else { canvas.style.borderColor = '#8b5cf6'; canvas.style.boxShadow = '0 0 30px rgba(139, 92, 246, 0.5), 0 0 60px rgba(139, 92, 246, 0.3)';}
            ctx.clearRect(0,0,canvas.width,canvas.height); ctx.strokeStyle='rgba(255,255,255,0.05)';ctx.lineWidth=1;
            for(let x=0;x<=COLS;x++){ctx.beginPath();ctx.moveTo(x*BLOCK_SIZE,0);ctx.lineTo(x*BLOCK_SIZE,canvas.height);ctx.stroke();}
            for(let y=0;y<=ROWS;y++){ctx.beginPath();ctx.moveTo(0,y*BLOCK_SIZE);ctx.lineTo(canvas.width,y*BLOCK_SIZE);ctx.stroke();}
            const boardData=generateBoard(lockedPieces);
            boardData.forEach((row,y)=>{ if(y<HIDDEN_ROWS)return; row.forEach((c,x)=>{ if(c!==0&&c!=='C')drawBlock(x,y-HIDDEN_ROWS,COLORS[c]); else if(c==='C')drawBlock(x,y-HIDDEN_ROWS,'#ffffff');});});
            if(currentPiece) {
                let ghostY=currentPiece.y; while(isValidPosition(currentPiece,currentPiece.x,ghostY+1))ghostY++;
                currentPiece.shape.forEach((r,y)=>r.forEach((c,x)=>{ if(c>0&&ghostY+y>=HIDDEN_ROWS)drawBlock(currentPiece.x+x,ghostY+y-HIDDEN_ROWS,'rgba(255,255,255,0.2)',true); if(c>0&&currentPiece.y+y>=HIDDEN_ROWS)drawBlock(currentPiece.x+x,currentPiece.y+y-HIDDEN_ROWS,currentPiece.color);}));
            }
        }
        function drawBlock(x,y,c,isGhost=false) {
            ctx.fillStyle=c; ctx.fillRect(x*BLOCK_SIZE,y*BLOCK_SIZE,BLOCK_SIZE,BLOCK_SIZE);
            if(!isGhost){
                const highlightSize = Math.max(1, BLOCK_SIZE / 5);
                const highlightOffset = Math.max(1, BLOCK_SIZE / 15);
                ctx.fillStyle='rgba(255,255,255,0.3)';
                ctx.fillRect(x*BLOCK_SIZE+highlightOffset,y*BLOCK_SIZE+highlightOffset,highlightSize,highlightSize);

                const borderOffset = Math.max(0.5, BLOCK_SIZE / 30);
                ctx.strokeStyle='rgba(0,0,0,0.5)';
                ctx.lineWidth= Math.max(1, BLOCK_SIZE / 15);
                ctx.strokeRect(x*BLOCK_SIZE+borderOffset,y*BLOCK_SIZE+borderOffset,BLOCK_SIZE-(2*borderOffset),BLOCK_SIZE-(2*borderOffset));
            }
        }
        function drawNextPieces() {
            nextCanvases.forEach((canv,idx)=>{
                const ctx2=canv.getContext('2d'); ctx2.clearRect(0,0,canv.width,canv.height);
                if(nextPieces[idx]){
                    const s=SHAPES[nextPieces[idx]], c=COLORS[nextPieces[idx]], bs = BLOCK_SIZE * (idx === 0 ? 0.4 : 0.33), ox=(canv.width-s[0].length*bs)/2, oy=(canv.height-s.length*bs)/2;
                    s.forEach((r,y)=>r.forEach((cell,x)=>{
                        if(cell>0){
                            ctx2.fillStyle=c;
                            ctx2.fillRect(ox+x*bs,oy+y*bs,bs,bs);
                            if(idx===0){
                                const highlightSize = Math.max(1, bs/4);
                                const highlightOffset = Math.max(1, bs/12);
                                ctx2.fillStyle='rgba(255,255,255,0.3)';
                                ctx2.fillRect(ox+x*bs+highlightOffset,oy+y*bs+highlightOffset,highlightSize,highlightSize);
                            }
                            ctx2.strokeStyle='rgba(0,0,0,0.5)';
                            ctx2.lineWidth=Math.max(0.5, bs/12);
                            ctx2.strokeRect(ox+x*bs,oy+y*bs,bs,bs);
                        }
                    }));
                }
            });
        }
        function updateStats() {
            document.getElementById('score').textContent=score; document.getElementById('lines').textContent=lines;
            const lvlEl=document.getElementById('level'); lvlEl.textContent=level; lvlEl.className='stat-value'; if(level>=10)lvlEl.classList.add('danger');else if(level>=5)lvlEl.classList.add('warning');
            document.getElementById('next-level').textContent=linesUntilNextLevel;
            const baseSpd=LEVEL_SPEEDS[0], currSpd=LEVEL_SPEEDS[Math.min(level-1, LEVEL_SPEEDS.length-1)], spdMult=(baseSpd/currSpd).toFixed(1);
            const spdEl=document.getElementById('speed'); spdEl.textContent=`${spdMult}x`; spdEl.className='stat-value'; if(parseFloat(spdMult)>=20)spdEl.classList.add('danger');else if(parseFloat(spdMult)>=5)spdEl.classList.add('warning');
            const elapsed=(Date.now()-startTime)/60000; document.getElementById('bpm').textContent=elapsed>0?~~(piecesPlaced*4/elapsed):0;
        }
        function showScorePopup(p) { const el=document.createElement('div'); el.className='score-popup'; el.textContent=`+${p}`; el.style.left='50%';el.style.top='50%'; const c=document.getElementById('score-popups');c.appendChild(el); setTimeout(()=>c.removeChild(el),1000); }
        function showLevelUpNotification(lvl) {
            const n=document.createElement('div'); n.style.cssText=`position:absolute;top:30%;left:50%;transform:translate(-50%,-50%);font-family:'Orbitron',sans-serif;font-size:32px;font-weight:900;color:#fbbf24;text-shadow:0 0 20px rgba(251,191,36,0.8);animation:levelUp 1.5s ease-out forwards;pointer-events:none;z-index:100;`;
            n.textContent=`LEVEL ${lvl}!`; const s=document.createElement('style'); s.textContent=`@keyframes levelUp{0%{transform:translate(-50%,-50%) scale(0.5);opacity:0;}50%{transform:translate(-50%,-50%) scale(1.2);opacity:1;}100%{transform:translate(-50%,-200%) scale(1);opacity:0;}}`;
            document.head.appendChild(s); const c=document.getElementById('score-popups');c.appendChild(n); setTimeout(()=>{c.removeChild(n);document.head.removeChild(s);},1500);
        }
        function gameLoop(time) {
            if(isGameOver)return; const delta=time-lastTime; lastTime=time;
            if(!isProcessingPhysics&&currentPiece){ dropCounter+=delta; if(dropCounter>dropInterval)softDrop(); }
            draw(); updateStats(); animationId=requestAnimationFrame(gameLoop);
        }
        function startGame() {
            document.getElementById('start-modal').classList.remove('visible');
            document.getElementById('game-over-modal').classList.remove('visible');
            resetGame();
            lastTime = performance.now();
            if (animationId) cancelAnimationFrame(animationId);
            if (settings.backgroundMode === 'Random') {
                startRandomThemeChanger();
            }
            animationId = requestAnimationFrame(gameLoop);
        }
        function gameOver() {
            isGameOver = true;
            stopRandomThemeChanger();
            soundManager.playGameOver();
            const speedMultiplier=(LEVEL_SPEEDS[0]/dropInterval).toFixed(1);
            document.getElementById('final-stats').innerHTML=`<div style="font-size:24px;margin-bottom:10px;color:#fbbf24;">Score: ${score}</div><div style="margin-bottom:5px;">Level ${level} (${speedMultiplier}x speed)</div><div>Lines Cleared: ${lines}</div>`;
            document.getElementById('game-over-modal').classList.add('visible');
        }
        function sleep(ms){return new Promise(resolve=>setTimeout(resolve,ms));}
        function toggleFullScreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen().catch(err => {
                    console.error(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                if (document.exitFullscreen) document.exitFullscreen();
            }
        }
        function setupUI(){
            const sm=document.getElementById('settings-modal');
            document.getElementById('settings-btn').addEventListener('click',()=>sm.classList.add('visible'));
            document.getElementById('close-settings').addEventListener('click',()=>sm.classList.remove('visible'));
            document.getElementById('fullscreen-toggle').addEventListener('click', toggleFullScreen);
            document.getElementById('next-track-btn').addEventListener('click', () => soundManager.nextTrack());
            const ds=document.getElementById('das-delay'),dv=document.getElementById('das-delay-value'),is=document.getElementById('das-interval'),iv=document.getElementById('das-interval-value');
            ds.value=settings.dasDelay;dv.textContent=settings.dasDelay; is.value=settings.dasInterval;iv.textContent=settings.dasInterval;
            ds.addEventListener('input',(e)=>{settings.dasDelay=parseInt(e.target.value);dv.textContent=settings.dasDelay;saveSettings();});
            is.addEventListener('input',(e)=>{settings.dasInterval=parseInt(e.target.value);iv.textContent=settings.dasInterval;saveSettings();});
            const mt=document.getElementById('music-track');
            mt.value=settings.musicTrack;
            mt.addEventListener('change',(e)=>{settings.musicTrack=e.target.value;soundManager.setTrack(settings.musicTrack);saveSettings();});
            const st=document.getElementById('sfx-set');
            st.value=settings.soundSet;
            st.addEventListener('change',(e)=>{settings.soundSet=e.target.value;soundManager.setSoundSet(settings.soundSet);saveSettings();});

            const bgModeSelect = document.getElementById('background-mode');
            const themeSetting = document.getElementById('theme-setting');
            const bgThemeSelect = document.getElementById('background-theme');

            function setThemeSelectorVisibility(visible) {
                themeSetting.style.display = visible ? 'contents' : 'none';
            }

            bgModeSelect.value = settings.backgroundMode;
            bgThemeSelect.value = settings.backgroundTheme;
            setThemeSelectorVisibility(settings.backgroundMode === 'Specific');

            bgModeSelect.addEventListener('change', (e) => {
                settings.backgroundMode = e.target.value;
                stopRandomThemeChanger();
                if (settings.backgroundMode === 'Specific') {
                    setThemeSelectorVisibility(true);
                    setBackground(settings.backgroundTheme);
                } else {
                    setThemeSelectorVisibility(false);
                    if (settings.backgroundMode === 'Random' && !isGameOver) {
                        startRandomThemeChanger();
                    } else { // Level mode
                        updateBackground(level);
                    }
                }
                saveSettings();
            });

            bgThemeSelect.addEventListener('change', (e) => {
                settings.backgroundTheme = e.target.value;
                if (settings.backgroundMode === 'Specific') {
                    setBackground(settings.backgroundTheme);
                }
                saveSettings();
            });

            document.querySelectorAll('.key-input').forEach(el=>{ const a=el.id.substring(4);el.textContent=settings.keyBindings[a];el.addEventListener('click',()=>listenForKey(el));el.addEventListener('keydown',(e)=>handleKeybinding(e,el)); });
            updateControlsDisplay();
        }
        function listenForKey(el) { document.querySelectorAll('.key-input').forEach(e=>e.classList.remove('listening')); el.classList.add('listening'); el.textContent='Press a key...'; }
        function handleKeybinding(e,el){ e.preventDefault(); const a=el.id.substring(4), k=e.key===' '?'Space':e.key; if(Object.values(settings.keyBindings).includes(k)&&settings.keyBindings[a]!==k){ el.textContent=settings.keyBindings[a];el.classList.remove('listening');return; } settings.keyBindings[a]=k; el.textContent=k; el.classList.remove('listening'); saveSettings(); updateControlsDisplay(); }
        function saveSettings(){localStorage.setItem('quadraSettings',JSON.stringify(settings));}
        function loadSettings(){ const s=localStorage.getItem('quadraSettings'); if(s){ const l=JSON.parse(s); settings={...settings,...l}; settings.keyBindings={...settings.keyBindings,...l.keyBindings};} soundManager.musicTrack=settings.musicTrack; soundManager.soundSet=settings.soundSet; }
        function updateControlsDisplay(){ const l=document.getElementById('controls-list');l.innerHTML=''; const o=['moveLeft','moveRight','rotateRight','rotateLeft','flip','softDrop','hardDrop','toggleMusic']; o.forEach(a=>{if(settings.keyBindings[a]){const t=a.replace(/([A-Z])/g,' $1').replace(/^./,s=>s.toUpperCase());l.innerHTML+=`<div>${t}: ${settings.keyBindings[a]}</div>`;}}); }
        let keyMap={};
        document.addEventListener('keydown',(e)=>{
            if(document.activeElement.classList.contains('key-input'))return;
            if(document.getElementById('start-modal').classList.contains('visible')||document.getElementById('game-over-modal').classList.contains('visible')){startGame();return;}
            if(isGameOver)return; const k=e.key===' '?'Space':e.key, a=Object.keys(settings.keyBindings).find(key=>settings.keyBindings[key]===k);
            if(!a||keyMap[a])return; keyMap[a]=true;
            if(isProcessingPhysics){ if(!inputQueue&&(a==='moveLeft'||a==='moveRight'||a.startsWith('rotate')||a==='flip')){inputQueue={type:a.startsWith('rotate')||a==='flip'?'rotate':'move',dir:a==='moveLeft'?-1:(a==='moveRight'?1:(a==='rotateLeft'?'left':(a==='flip'?'flip':'right')))};}return;}
            switch(a){
                case'moveLeft':move(-1);dasTimer=setTimeout(()=>{dasIntervalTimer=setInterval(()=>move(-1),settings.dasInterval);},settings.dasDelay);break;
                case'moveRight':move(1);dasTimer=setTimeout(()=>{dasIntervalTimer=setInterval(()=>move(1),settings.dasInterval);},settings.dasDelay);break;
                case'softDrop':softDrop();break; case'rotateRight':rotate('right');break; case'rotateLeft':rotate('left');break; case'flip':rotate('flip');break;
                case'hardDrop':e.preventDefault();hardDrop();break;
                case'toggleMusic':const m=soundManager.toggleMute();document.getElementById('sound-toggle').textContent=m?'🔇':'🔊';break;
            }
        });
        document.addEventListener('keyup',(e)=>{
            const k=e.key===' '?'Space':e.key, a=Object.keys(settings.keyBindings).find(key=>settings.keyBindings[key]===k);
            if(a)keyMap[a]=false; if(a==='moveLeft'||a==='moveRight'){clearTimeout(dasTimer);clearInterval(dasIntervalTimer);dasIntervalTimer=null;dasIntervalTimer=null;}
        });
        window.addEventListener('load', init);
    </script>
</body>
</html>

