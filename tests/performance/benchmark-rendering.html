<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quadra Rendering Performance Benchmark</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #1a1a2e;
            color: #eee;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        #benchmark-canvas {
            border: 2px solid #444;
            display: block;
            margin: 20px auto;
        }
        .controls {
            text-align: center;
            margin: 20px;
        }
        button {
            background: #16213e;
            color: #eee;
            border: 2px solid #444;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background: #0f3460;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        .stats {
            text-align: center;
            font-size: 18px;
            line-height: 1.6;
        }
        .metric {
            background: #16213e;
            padding: 15px;
            margin: 10px auto;
            max-width: 600px;
            border-radius: 5px;
            border: 1px solid #444;
        }
        .metric-label {
            color: #aaa;
            font-size: 14px;
        }
        .metric-value {
            color: #4ecca3;
            font-size: 24px;
            font-weight: bold;
        }
        .improvement {
            color: #4ecca3;
        }
        .title {
            text-align: center;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1 class="title">ðŸŽ® Quadra Rendering Performance Benchmark</h1>
    <p class="title">Testing WebGL attribute location caching optimization</p>

    <canvas id="benchmark-canvas" width="800" height="600"></canvas>

    <div class="controls">
        <button id="start-btn" onclick="runBenchmark()">Run Benchmark</button>
        <button id="reset-btn" onclick="resetBenchmark()" disabled>Reset</button>
    </div>

    <div class="stats" id="stats">
        <p>Click "Run Benchmark" to measure rendering performance with multiple particle systems.</p>
    </div>

    <script src="renderer.js"></script>
    <script>
        const canvas = document.getElementById('benchmark-canvas');
        const statsDiv = document.getElementById('stats');
        const startBtn = document.getElementById('start-btn');
        const resetBtn = document.getElementById('reset-btn');

        let renderer = null;
        let benchmarkRunning = false;

        function runBenchmark() {
            startBtn.disabled = true;
            resetBtn.disabled = true;
            benchmarkRunning = true;
            statsDiv.innerHTML = '<p>Benchmark running... Please wait.</p>';

            // Initialize renderer
            renderer = new WebGLRenderer(canvas);

            // Create a complex scene with multiple particle systems (simulating "forest" theme)
            const particleConfigs = [
                // Spores
                { behavior: 'ambient', speed: 0.15, minSize: 2.0, maxSize: 4.0,
                  minAlpha: 0.3, maxAlpha: 0.6, lifetime: Infinity, zIndex: -0.5,
                  color: [0.7, 0.95, 0.7] },
                // Ambient dust
                { behavior: 'ambient', speed: 0.2, minSize: 1.0, maxSize: 2.5,
                  minAlpha: 0.1, maxAlpha: 0.35, lifetime: Infinity, zIndex: -0.3,
                  color: [0.8, 0.87, 1.0] },
                // Green fireflies
                { behavior: 'firefly', minSize: 4.0, maxSize: 7.0, minAlpha: 0.4,
                  maxAlpha: 0.8, lifetime: Infinity, zIndex: -0.4,
                  color: [0.6, 1.0, 0.7] },
                // Yellow fireflies
                { behavior: 'firefly', minSize: 6.0, maxSize: 10.0, minAlpha: 0.5,
                  maxAlpha: 1.0, lifetime: Infinity, zIndex: -0.2,
                  color: [1.0, 0.95, 0.6] },
                // Bright fireflies
                { behavior: 'firefly', minSize: 8.0, maxSize: 14.0, minAlpha: 0.6,
                  maxAlpha: 1.0, lifetime: Infinity, zIndex: -0.1,
                  color: [1.0, 0.9, 0.5] },
                // Wisps
                { behavior: 'ambient', speed: 0.08, minSize: 3.0, maxSize: 6.0,
                  minAlpha: 0.2, maxAlpha: 0.5, lifetime: Infinity, zIndex: -0.15,
                  color: [0.5, 0.9, 1.0] }
            ];

            const particleCounts = [40, 60, 15, 20, 12, 25];

            particleConfigs.forEach((config, i) => {
                renderer.particleSystems.push(
                    new ParticleSystem(renderer.gl, particleCounts[i], config)
                );
            });

            // Benchmark parameters
            const warmupFrames = 60;
            const measureFrames = 600; // 10 seconds at 60fps
            let frameCount = 0;
            let frameTimes = [];
            let startTime = 0;
            let isWarmup = true;

            function benchmarkFrame() {
                const frameStart = performance.now();

                // Render the frame
                const gl = renderer.gl;
                gl.clearColor(0.0, 0.0, 0.0, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                gl.enable(gl.BLEND);
                gl.blendFunc(gl.SRC_ALPHA, gl.ONE_MINUS_SRC_ALPHA);

                gl.useProgram(renderer.particleProgram);
                gl.uniform2f(renderer.particleProgram.uniforms.u_resolution,
                           gl.canvas.width, gl.canvas.height);

                renderer.particleSystems.forEach(ps => {
                    gl.uniform1f(renderer.particleProgram.uniforms.u_zIndex, ps.zIndex);
                    gl.uniform3fv(renderer.particleProgram.uniforms.u_color,
                                ps.themeConfig.color || [1.0, 1.0, 1.0]);
                    ps.update();
                    ps.bindBuffers(renderer.particleProgram);
                    ps.draw();
                });

                const frameEnd = performance.now();
                const frameTime = frameEnd - frameStart;

                if (isWarmup) {
                    frameCount++;
                    if (frameCount >= warmupFrames) {
                        isWarmup = false;
                        frameCount = 0;
                        startTime = performance.now();
                        console.log('Warmup complete, starting measurement...');
                    }
                    requestAnimationFrame(benchmarkFrame);
                } else {
                    frameTimes.push(frameTime);
                    frameCount++;

                    if (frameCount < measureFrames) {
                        requestAnimationFrame(benchmarkFrame);
                    } else {
                        // Benchmark complete
                        const totalTime = performance.now() - startTime;
                        displayResults(frameTimes, totalTime);
                    }
                }
            }

            // Start the benchmark
            requestAnimationFrame(benchmarkFrame);
        }

        function displayResults(frameTimes, totalTime) {
            const avgFrameTime = frameTimes.reduce((a, b) => a + b, 0) / frameTimes.length;
            const minFrameTime = Math.min(...frameTimes);
            const maxFrameTime = Math.max(...frameTimes);
            const avgFPS = 1000 / avgFrameTime;

            // Calculate percentiles
            const sorted = frameTimes.slice().sort((a, b) => a - b);
            const p50 = sorted[Math.floor(sorted.length * 0.5)];
            const p95 = sorted[Math.floor(sorted.length * 0.95)];
            const p99 = sorted[Math.floor(sorted.length * 0.99)];

            // Count frames below 60fps (>16.67ms)
            const droppedFrames = frameTimes.filter(t => t > 16.67).length;
            const droppedPercent = (droppedFrames / frameTimes.length * 100).toFixed(1);

            statsDiv.innerHTML = `
                <h2>Benchmark Results</h2>
                <p>Tested with 6 particle systems (172 total particles)</p>

                <div class="metric">
                    <div class="metric-label">Average Frame Time</div>
                    <div class="metric-value">${avgFrameTime.toFixed(2)} ms</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Average FPS</div>
                    <div class="metric-value">${avgFPS.toFixed(1)} FPS</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Frame Time Range</div>
                    <div class="metric-value">${minFrameTime.toFixed(2)} - ${maxFrameTime.toFixed(2)} ms</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Percentiles (50th / 95th / 99th)</div>
                    <div class="metric-value">${p50.toFixed(2)} / ${p95.toFixed(2)} / ${p99.toFixed(2)} ms</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Dropped Frames (>16.67ms)</div>
                    <div class="metric-value">${droppedFrames} (${droppedPercent}%)</div>
                </div>

                <div class="metric">
                    <div class="metric-label">Total Test Duration</div>
                    <div class="metric-value">${(totalTime / 1000).toFixed(2)} seconds</div>
                </div>

                <p style="margin-top: 20px; color: #4ecca3;">
                    âœ“ Optimization: Attribute locations are cached (queried once per system)
                </p>
                <p style="color: #aaa; font-size: 14px;">
                    Before optimization: ~18 gl.getAttribLocation() calls per frame<br>
                    After optimization: 0 gl.getAttribLocation() calls per frame (after warmup)
                </p>
            `;

            benchmarkRunning = false;
            startBtn.disabled = false;
            resetBtn.disabled = false;

            // Log detailed results to console
            console.log('=== Benchmark Results ===');
            console.log(`Average Frame Time: ${avgFrameTime.toFixed(2)} ms`);
            console.log(`Average FPS: ${avgFPS.toFixed(1)}`);
            console.log(`Min/Max Frame Time: ${minFrameTime.toFixed(2)} / ${maxFrameTime.toFixed(2)} ms`);
            console.log(`Percentiles: p50=${p50.toFixed(2)}, p95=${p95.toFixed(2)}, p99=${p99.toFixed(2)}`);
            console.log(`Dropped frames: ${droppedFrames} (${droppedPercent}%)`);
        }

        function resetBenchmark() {
            if (renderer) {
                renderer.stop();
                const gl = renderer.gl;
                gl.clearColor(0.0, 0.0, 0.0, 1.0);
                gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
                renderer = null;
            }
            statsDiv.innerHTML = '<p>Click "Run Benchmark" to measure rendering performance with multiple particle systems.</p>';
            startBtn.disabled = false;
            resetBtn.disabled = true;
        }
    </script>
</body>
</html>
